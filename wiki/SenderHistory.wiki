<h1>Сендер и его история</h1>
<p>На этой странице вы можете узнать о том, что такое "сендер", какие версии
и варианты программ этого семейства бывали в общежитии, а также то, как им
пользоваться, и почему в общежитии пользуются именно такой программой, а не
каким-нибудь <a href="#whynotchat">чатом</a>. Не стоит пугаться скроллбара :-)
просто на этой странице много картинок. А еще здесь, кроме самой истории, есть
выводы и анализ причин успехов и неудач программных проектов. Если кто-нибудь
из читателей собирается работать в IT-индустрии и поддерживать свой продукт,
эти примеры могут оказаться весьма полезны, а иногда и послужить поучительным
уроком...</p>
<table width="100%"><tr><td width="30%">&nbsp;</td><td><i><div style="text-align: right;">
&laquo;Те, кто не помнит прошлого, обречены повторять его снова и снова&raquo;
<br><b>Джордж Сантаяна</b></div></i></td></tr></table>

<h2>Краткое оглавление (для тех, кому лень читать целиком)</h2>
<a name="toc"></a>
<p><a href="#birth">Рождение</a></p>
<p><a href="#tcps098">TCPSender 0.9.8</a></p>
<p class="small" style="text-indent:34pt;"><a href="#tcpsint">Устройство TCPSender 0.9.8 и другие его возможности</a></p>
<p class="small" style="text-indent:34pt;"><a href="#tcpsbugs">Проблемы TCPSender 0.9.8 и его дальнейшая история</a></p>
<p><a href="#whynotchat">Лирическое отступление: почему сендер, а не чат?</a></p>
<p><a href="#spsender">SPSender</a></p>
<p><a href="#seahist">SEA Sender: интриги и политика</a></p>
<p class="small" style="text-indent:34pt;"><a href="#seautumn">Осеннее обострение</a></p>
<p class="small" style="text-indent:34pt;"><a href="#seavtfnet">Холодная война и железный занавес</a></p>
<p class="small" style="text-indent:34pt;"><a href="#seahack">Почти детективная история</a></p>
<p class="small" style="text-indent:34pt;"><a href="#seasunset">Времена упадка и запустения</a></p>
<p class="small" style="text-indent:34pt;"><a href="#seabugs">Галерея скриншотов багов SEA Sender</a></p>
<p><a href="#blastcore">Настоящее время</a></p>
<p><a href="#seashit">Недостатки SEA Sender с точки зрения программиста</a></p>
<p class="small" style="text-indent:34pt;"><a href="#javashit">Проблемы реализации</a></p>
<p class="small" style="text-indent:34pt;"><a href="#seafixes">Возможные улучшения</a></p>
<p><a href="#thsender">Каким могло бы быть будущее</a></p>
<p class="small" style="text-indent:34pt;"><a href="#thsender">TheSender</a></p>
<p class="small" style="text-indent:34pt;"><a href="#kpot">Предложение Крота</a></p><a name="birth"><h2>Рождение</h2></a>
<p>Вскоре после зарождения сети пользователям потребовалось средство для
общения. Ведь бегать из комнаты в комнату для того, чтобы что-то
сказать, неудобно, почему бы не сделать это средствами самой сети? Возникает
лишь вопрос, каким средством. Естественно, что прежде всего были использованы
программы, входящие в состав ОС, стандартная "Служба сообщений" Windows. На
Windows NT (а также на появившихся спустя годы Windows 2000 и Windows XP) это
была утилита командной строки <tt>net send</tt>, а на Windows 95 и 98 &mdash;
утилита WinPopup.</p>
<a name="img-winpopup"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/winpopup.gif"
width="640" height="480" align="center" alt="" title=""></a>
<p>WinPopup, как можно видеть по скриншоту, умел немного &mdash; всего-то
отправить сообщение на компьютер или рабочую группу, сыграть звук по приходу
сообщения, да пролистать/удалить то, что пришло. Максимальный размер сообщения
был невелик, и имена получателей приходилось каждый раз набирать вручную. Одним
словом, неудобно. Совсем неудобно.</p>
<p>Промучившись так первое время, первый админ сети, Александр Александр<i>о</i>в,
принимает решение писать свою замену WinPopup, позже названную TCPSender.
Сейчас это может показаться странным, когда существует большое количество
разнообразных программ для общения. Но какие тогда были альтернативы? На дворе
был 1997 год, локалка общежития АВТФ &mdash; одна из первых по стране, то, что позже
назовут "домашними сетями", еще только зарождалось. Единственным вариантом мог
быть лишь <acronym title="Internet Relay Chat">IRC</acronym>, но в те годы и
он еще лишь адаптировался к российским условиям (существующая и поныне IRC-сеть
<a href="http://www.rus-net.org/">RusNet</a> родилась примерно в то же время).
Кроме того, IRC построен на клиент-серверной архитектуре, а в то время доступ
в Интернет у общаги был не всегда, да и создавать единую точку отказа в виде
сервера никто не хотел.</p>
<p>Итак, Александров пишет TCPSender. Первоначально программа отличалась от
WinPopup не очень значительно, но уже имела список пользователей справа, где
было видно, кто сейчас есть в онлайне, и можно было послать пользователю
сообщение, просто щелкнув по нему. Сразу после Нового 1998 Года программа
достигает версии 0.9.2:</p>
<a name="img-tcpsmain092"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-main-092.png"
width="389" height="308" align="center" alt="TCPSender 0.9.2" title=""></a>
<p>В обиходе программу стали называть просто "сендер", в разговорах жителей
общаги часто стало можно слышать "я тебе в сендер напишу", "какой у тебя ник в
сендере?", "позвони мне в сендер как придешь", и т.д.</p>
<p>В конце января 1998 года выходит версия 0.9.7, а затем &mdash; 0.9.8 beta,
которая осталась в использовании на много лет. Рассмотрим её поподробнее.</p>
<p class="small" style="text-align: right;"><a href="#toc">назад к оглавлению</a></p>
<a name="tcps098"><h2>TCPSender 0.9.8 beta: что он умел и как им пользоваться</h2></a>
<table align="right" style="margin: 9px;" border="0"><tr valign="top"><td width="352" height="223">
<a name="img-tcps-about"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-about.png"
width="352" height="223" align="right" hspace="5" vspace="1"
alt="TCPSender 0.9.8 beta - О программе"></a></td></tr>
<tr><td><p class="small">TCPSender 0.9.8 beta &mdash; окно "О программе"</p>
</td></tr></table>
<p>Главное окно имело панель с кнопками, выпадающий список принятых сообщений,
поле отображения текста сообщения, и список пользователей. Пользователи
именовались в формате "Имя пользователя[Имя_компьютера]", причем оба имени
брались из системных настроек Windows &mdash; т.е. совпадали с тем, что видно в
"Сетевом окружении".</p>
<p>Двойным щелчком по имени пользователя в списке (или выбором в контекстном
меню) можно было открыть окно отправки ему сообщения. Иконки показывали, в
онлайне пользователь сейчас, или же его машина выключена (показ оффлайновых
можно было и скрыть в настройках).</p>
<p>Можно было и нажать кнопку "Ответить" &mdash; в таком случае, текст текущего
сообщение <i>цитировался</i> в окне редактирования сообщения по принципам,
аналогичным в FidoNet/e-mail: каждая строчка оригинала снабжалась символом
"<b><tt>&gt;</tt></b>", перед которым приписывалось имя пользователя,
написавшего этот текст. Таким образом, среди кучи сообщений становилось
возможным различать, кто на что отвечал, а в случае личной переписки с большим
временн<i>ы</i>м интервалом &mdash; и вспомнить, о чем шла речь.</p>
<table border="0"><tr valign="top"><td width="800" height="600">
<a name="img-tcps-main"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-main.jpg"
width="800" height="600" align="center" hspace="5" vspace="1" alt="TCPSender
0.9.8 beta - главное окно и окно отправки" title=""></a></td></tr>
<tr><td><p class="small">TCPSender 0.9.8 beta &mdash; главное окно и окно отправки
сообщения</p>
</td></tr></table>
<p>Сообщения можно было перелистывать кнопками со стрелками на панели (или
нажимать Ctrl+стрелки на клавиатуре) либо выбрать напрямую в выпадающем
списке, где писалось, кто автор, кому предназначено, время написания, а также
иконка слева показывала, было ли это сообщение приватным (личным) или же для
всей группы:</p>
<a name="img-tcps-main-cbox"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-main-cbox.png"
width="453" height="360" align="center" alt="" title=""></a>
<p>Кроме того, кнопки-стрелки на панели инструментов и кнопка удаления понимали
щелчок правой кнопкой мыши, показывая меню, в котором можно было переместиться
в начало или конец списка, а также удалить сразу много сообщений:</p>
<a name="img-tcps-main-delpopup"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-main-delpopup.png"
width="367" height="147" align="center" alt="" title=""></a>
<p>Если нужно было написать сообщение, можно было нажать кнопку нового (самая
левая на панели) или дважды щелкнуть пользователя в списке, тогда открывалось
окно отправки сообщения. В нём тоже имелся выпадающий список, но уже с
пользователями и группами &mdash; например, в случае "писал-писал одному в приват и
вдруг решил отправить всем" можно было открыть список и выбрать другого:</p>
<a name="img-tcps-send-cbox"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-send-cbox.png"
width="362" height="269" align="center" alt="" title=""></a>
<p>Частенько компьютеры не выключаются на ночь, а есть, например, потребность
периодически отсылать объявления &mdash; для тех, кто еще не видел. В таком разе
заново набирать сообщение как-то лениво. Поэтому сендер имеет окно с перечнем
всех ранее отосланных сообщений, можно выбрать и отослать заново (отредактировав
при необходимости):</p>
<a name="img-tcps-sentmsgs"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-sentmsgs.png"
width="670" height="536" align="center" alt="" title=""></a>
<p>Если в настройках сендера стояла соответствующая галка, то при каждой
отправке сообщения выскакивало окно, которое показывало, действительно ли
сообщение доставлено получателям &mdash; и кому из них. Впрочем, если сообщение было
кому-то доставлено, это еще не значит, что оно до него дошло :-)</p>
<a name="img-tcps-delivered"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-delivered.png"
width="373" height="344" align="center" alt="" title=""></a>
<p>Конечно, сообщения удобны, если Вы задаете вопрос всей общаге сразу &mdash; кто-то
ответит раньше, кто-то позже... Но что, если внимание собеседника нужно привлечь
немедленно? В этом случае поможет режим чата: на нужном пользователе в списке
ткнуть правой кнопкой и выбрать Chat &mdash; тогда на машине собеседника раздастся
звук звонка телефона и появится окно, позволяющее принять "звонок" или же
сбросить. Или ничего не делать (потому что Вас нет у компа, например), тогда
вызывающий сам устанет и отменит &mdash; а у вызываемого в списке сообщений
появится, что у вас, мол, был звонок от того-то, Вы не ответили, он повесил
трубку и это печально. В противном же случае открывалось окно чата на двоих.
Оно содержало кнопку, при нажатии которой на том конце снова раздавался звук
звонка &mdash; на случай, если собеседник вдруг заснул и не отвечает :-)</p>
<a name="img-tcps-chat"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-chat.jpg"
width="800" height="600" align="center" alt="" title=""></a>
<p>Осталось добавить только, что к программе настолько привыкли, что она
стала частью традиций, можно сказать, духа общаги АВТФ. Вот как описывает его
один из старых студентов:</p>
<blockquote>
<p>Своё первое &laquo;знакомство&raquo; с сендером я вспоминаю примерно
так:</p>
<p>Учиться мы приехали сразу на второй курс. Зелёные, одомашненные,
практически абитура! При попадании в новую языковую среду, наверно больше
половины слов не понимались вообще. Меня и моего однокашника поселили вместе
с Акой &mdash; легендарным КС-снайпером общаги АВТФ в то время.</p>
<p>Ака на первых порах и был нашим путеводителем по всему неизведанному. По
тем временам компьютер не был той заурядностью, какой он является сейчас и в
комнате он был только у Тимура (aka). Нужно отметить, что Тимур не был жмотом
и давал пользоваться его компьютером, если конечно это не было время
кланвара.</p>
<p>&laquo;Что это такое?&raquo; &mdash; полюбопытствовал я, когда впервые увидел
яркий значок неподалёку от системного времени. &laquo;Сендер!&raquo; &mdash;
буркнул Тимур, будто это не было чем-то необычным, и продолжил планировать
атаку на вечер.</p>
<p>Ещё некоторое время TCPSender так и пробыл некоторой тайной, но в скором
времени влился и в нашу студенческую повседневность и мы уже не представляли
потом, как же без него жили раньше =)</p>
</blockquote>
<p>С ним даже были связаны некоторые специфичные традиции, типа вечернего
счета (кто пишет на группу "1", другой на группу отвечает "2", и считают, пока
кто-нибудь не пожалуется на флуд). Впрочем, об этом лучше слушать из уст
старожилов, чем читать...</p>
<p class="small" style="text-align: right;"><a href="#toc">назад к оглавлению</a></p>
<a name="tcpsint"><h3>Устройство TCPSender 0.9.8 и другие его возможности</h3></a>
<table align="right" border="0"><tr valign="top"><td width="367" height="147">
<a name="img-tcps-main-viewmenu"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-main-viewmenu.png"
width="367" height="147" align="center" hspace="5" vspace="1" alt="" title="">
</a></td></tr><tr><td><p class="small">TCPSender 0.9.8 beta &mdash; другие фичи</p>
</td></tr></table>
<p>Устроен TCPSender 0.9.8 был так: никакого сервера, каждая копия на каждой
машине открывает TCP-порт и слушает запросы на соединение. При этом на каждой
же машине каждая копия периодически сканирует заданный в настройках диапазон
IP-адресов. Ответили &mdash; значит, там пользователь жив. Не ответили &mdash; помечаем его
в списке как оффлайн. Отправка сообщений группе производилась точно таким же
образом &mdash; просто перебирались все в списке, но на этот раз быстро; получилось
соединиться &mdash; сообщение доставлено.</p>
<p>Данный подход имеет как плюсы, так и минусы. Плюсы заключались в том, что
для работы сендеров не требуется выделенный сервер &mdash; и если этот сервер вдруг
завис или просто становится недоступен, связь друг с другом не теряется. Такая
возможность &mdash; одна из целей при создании самого Интернета, между прочим. А
кроме того, каждый пользователь может самостоятельно настроить у себя сколько
угодно разных <i>групп</i>. Для управления ими был интерфейс, вызывавшийся
кнопкой с несколькими человечками на панели инструментов:</p>
<a name="img-tcps-grpmgr"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-grpmgr.gif"
width="418" height="250" align="center" alt="" title=""></a>
<p>Можно было и посмотреть, кто и в каких группах сейчас в онлайне:</p>
<a name="img-tcps-grptree"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-grptree.png"
width="417" height="373" align="center" alt="" title=""></a>
<p>Для автоматического заполнения групп по сканированию диапазонов IP-адресов
нужно было указать в окне настроек на вкладке сканпулов начальный адрес и
число адресов в диапазоне:</p>
<a name="img-tcps-opts-scanpool"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-opts-scanpool.jpg"
width="389" height="422" align="center" alt="" title=""></a>
<p>Но имела эта автономность и свои минусы. Прежде всего, минусом оборачивался
плюс независимой настройки групп &mdash; если у разных пользователей для группы "АВТФ"
были в списке разные машины, при ответе на группу его могли получить, например,
не все. С этим, впрочем, легко можно было справиться, покуда дело касалось
внутриобщажных пользователей (с городскими сложнее). Иногда приходилось из
списка некоторых пользователей вычищать вручную (например, на этом адресе уже
нет сендера):
<a name="img-tcps-removeusers"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-removeusers.png"
width="418" height="177" align="center" alt="" title=""></a>
<p>Но TCPSender 0.9.8 beta имел и свои глюки :-) Например, собственная машина
могла попасть в список несколько раз, под разными адресами. Тогда при отправке
сообщения на группу Вы получали своё же сообщение в нескольких дубликатах. Для
борьбы с этим багом задействовали удаление одного из них, вот так:</p>
<a name="img-tcps-removedaddrs"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-removedaddrs.png"
width="276" height="178" align="center" alt="" title=""></a>
<p>С этим подходом были и другие проблемы, но рассмотрим их позже, а
пока &mdash; осталось показать еще несколько скриншотов TCPSender 0.9.8 beta. Так,
у него была возможность auto-away: если Вы ничего не делали 10 (по умолчанию)
минут, он переходит в этот режим, и на любое входящее сообщение сработает
автоответчик с заданным текстом:</p>
<a name="img-tcps-opts-away"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-opts-away.png"
width="386" height="422" align="center" alt="" title=""></a>
<p>В меню можно было выбрать и "ручной" away, с текстом специально для данного
случая. Впрочем, работал он только для автоответчика &mdash; снаружи можно было лишь
посмотреть информацию о пользователе, каков его Status &mdash; online, away, autoaway...</p>
<a name="img-tcps-userinfo"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-userinfo.png"
width="306" height="206" align="center" alt="" title=""></a>
<p>Другие вкладки окна опций (картинки откроются в новом окне):</p>
<table border="1" cellspacing="5" cellpadding="15"><tr valign="top">
<td frame="border" border="1">
<a name="img-tcps-opts-chat"></a><a target="_blank"
href="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-opts-chat.png"><img
src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-opts-chat.png" width="193" height="211"
align="center" alt="" title=""></a>
<p class="small">Можно <s>грабить корованы</s> задавать звук и шрифт окну чата</p>
</td>
<td frame="box">
<a name="img-tcps-opts-general"></a><a target="_blank"
href="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-opts-general.jpg"><img
src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-opts-general.jpg" width="193" height="211"
align="center" alt="" title=""></a>
<p class="small">Вкладка с основными настройками</p>
</td>
<td frame="box">
<a name="img-tcps-opts-mail"></a><a target="_blank"
href="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-opts-mail.png"><img
src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-opts-mail.png" width="193" height="211"
align="center" alt="" title=""></a>
<p class="small">Автору были нужны уведомления о почте &mdash; и он их тоже приделал</p>
</td></tr></table>
<p class="small" style="text-align: right;"><a href="#toc">назад к оглавлению</a></p>
<a name="tcpsbugs"><h3>Проблемы TCPSender 0.9.8 и его дальнейшая история</h3></a>
<p>TCPSender 0.9.8 beta вышел в 1998 году и так навсегда и остался бетой. Тому
виной много причин. Прежде всего, Александров окончил учебу и передал "бразды
правления" следующему админу. Исходники сендера остались на жестком диске
первого общажного сервера... который спустя некоторое время погиб (диск, а не
сервер). И исходники вместе с ним. И так эта версия и осталась в использовании
надолго, тем более, что она в принципе устраивала всех. Тому подтверждением
может служить, что спустя лет 6 копии исходников обнаружились у аспирантов и
прочих оставшихся жить в общаге старшекурсников &mdash; но к этому моменту уже было
ясно, что писать его надо с нуля.</p>
<p>На это опять же было несколько причин. Во-первых, он был глючен, мог падать
и всякие фокусы выкидывать, зачастую обусловленные проблемами старой версии
Delphi, на которой он был написан. Причем с использованием таких компонентов,
что в более новых он уже не собирался (и попытки поправить были бы нетривиальны
ввиду имен вида TForm1..TForm14, и так везде). Но часть из них была терпима,
часть давно научились обходить верной расстановкой галочек в настройках.</p>
<p>Во-вторых, и это гораздо более серьезно &mdash; сканирование сети, как сейчас
говорят, плохо масштабировалось с ростом размера сети. В норме пробовался один
IP-адрес раз в 5 секунд. В результате полный цикл проверки онлайна всей сети
из 256 адресов занимал более 20 минут &mdash; и всё это время Ваш собеседник мог
считаться онлайн, в то время как он уже выключил свою машину. Попытки сделать
это время меньше (до 2006 года сеть еще не достигла такого количества человек)
путем указания поддиапазонов &mdash; вызывали необходимость всем переконфигурировать
сендер, когда подключались новые люди к сети. Кроме того, сохранение списка
машин в сети в реестре было реализовано глючно &mdash; в нем надолго могли оставаться
люди, которые уже съехали с общаги. А периодическая чистка и заполнение с нуля
часто наталкивалось уже на следующую, третью проблему.</p>
<p>В-третьих, сканирование было реализовано так, что сендер прямо в данных
пакета сообщал той стороне свой IP-адрес в текстовом виде, и она использовала
именно его. Всё бы ничего, но это приводило к проблемам, если был неверно
определен адрес своим сендером (например, создала вам VMWare виртуальную сеть
для виртуальной машины с фейковым адресом, а сендер посчитал основным именно
его), или в случае NAT. NAT, или "Общий доступ к соединению" на Windows,
выпускал в сеть через себя другой компьютер (через соединение с ним второй
сетевой картой). При этом такому компьютеру назначается "серый" приватный адрес
192.168.0.2 (обычно именно такой), видный только в этой внутренней сети. Если
на нём стоял сендер, то он, естественно, знал и сообщал только этот адрес. В
результате пользователь появлялся у других сендреов в списке, когда он сам их
сканировал, он мог отправлять им сообщений &mdash; но ответить ему было невозможно,
ибо нельзя соединиться с таким адресом снаружи. В общаге это не представляло
проблемы, поскольку такие внутренние сети существовали в пределах комнаты (а
позже их вообще запретили), и можно было обойтись одним сендером на комнату.
Но у городских NAT часто делал провайдер, и тут уже ничего сделать было
нельзя.</p>
<p>Стало ясным, что необходим клиент-серверный вариант. Но TCPSender 0.9.8 beta
успешно пережил первую попытку в 2005 и сдал свои позиции только после второй
попытки в 2006 году. И то постепенно &mdash; лишь в 2007 году он умер окончательно,
оставшись только у нескольких единиц человек из старожилов. Подробнее об этом &mdash;
в следующих разделах.</p>
<a name="whynotchat"><h2>Лирическое отступление: почему сендер, а не чат?</h2></a>
<p>Несмотря на все недостатки TCPSender 0.9.8, как баги, так и неудобства, им
в неизменном виде продолжали пользоваться многие годы. Ситуация тем более
интересна, что разнообразные программы для общения в локальной сети &mdash; чаты &mdash; к
тому времени уже появились, и даже в значительном количестве. Более того, были
и попытки ввести их в общаге &mdash; в составе нашей сети долгое время была сеть
общаги МСФ, и они, внутри своего сегмента, пользовались как раз такими чатами.
Однако следует обратить внимание, что их было гораздо меньше, чем на АВТФ, 40
человек, против полутора сотен (в те годы); в сендере максимальное число юзеров
в онлайне достигало 120. Кроме того, МСФ периодически меняли программы, одно
время у них был и известный VyPress Chat, потом они и от него отказались. АВТФ
же всегда оставался на сендере.</p>
<p>Причина этого лежит в плохоосознаваемой, если специально не задумываться,
разнице <i>концепций</i> сендера и чата. Каждый, кто хоть раз пользовался как
чатом, так и форумом или электронной почтой (особенно списками рассылки), сразу
поймет, что в них отличается <i>стиль</i> общения. Послушаем специалистов:</p>
<blockquote>
<p>Проблема нехватки паралингвистических средств характерна для всех форм
сетевого общения, однако в чатах эта проблема максимально болезненна (не
случайно компенсация смыслового ряда тела присутствует только в чатах), так
как все это усугубляется тем, что общение происходит в режиме реального
времени. У собеседников по сути отсутствует время на размышления над
литературной формой своего высказывания. Максимально допустимая временная
фора для ответа &mdash; 1-3 минуты, после этого смысла в ответе будет уже немного.
Так как на экран одновременно выплескивается большое количество реплик, то
через несколько минут послание, на которое вы отвечаете, будет безнадежно
погребено под массой позднейших и о нем забудут все, в том числе и автор.</p>
<p>Из технических особенностей чата вытекает и еще одна особенность общения.
Из-за того, что на экран одновременно поступает множество реплик, ограничение
объема реплик является насущной необходимостью. Как правило, объем реплики в
чате составляет в среднем три нераспространенных предложения. Именно по этой
причине в чатах часто весьма затруднены глубокомысленные беседы, которые
являются основным достоинством и недостатком другой глобальной формы сетевого
общения &mdash; конференций.</p>
</blockquote>
<p>Однако стиль форумов, конференций, хоть и годится для более-менее постоянной
переписки (которую можно перечитывать и спустя месяцы), всё же плохо подходит
для внутреннего общения, где темы гораздо более быстротекущи. Остается чат?
Но вспомним, что у чатов есть и другие проблемы:</p>
<blockquote>
<p>Все системы чата, включая IRC, однако, обладают общим фундаментальным
   свойством, исходящим из самой природы чата &mdash; предполагается очень
   быстрый обмен короткими фразами в течение продолжительного времени,
   что нередко не подходит &mdash; требуется послать не очень короткое
   сообщение (например "оставить записку"), причем лишь время от
   времени. Чат требует от пользователя реакции в реальном времени,
   не оставляя времени на долгие раздумья, вынуждая писать короткие
   (обычно однострочные) фразы, и практически мешает (во всяком случае,
   сделать нормой) писать длинные рассуждения или вставлять длинные
   цитаты текста. Это только усугубляется с ростом числа пользователей
   на одном канале &mdash; что, если разговор начнет вести одновременно
   большое число групп людей? В результате даже в крупных IRC-сетях
   количество человек на одном канале очень редко переваливает за сотню.</p>
</blockquote>
<p>Теперь вспомним количество человек на МСФ и АВТФ &mdash; действительно, уже другой
размер. Что, если писать станут все 100 человек? За этой кашей станет трудно
уследить, и уж точно это совершенно не нужно тому, кто ждёт только определенных
сообщений.</p>
<blockquote>
<p>Во многих случаях подходящим решением является смена парадигмы &mdash;
   вместо чата использовать сообщения относительно большой длины
   (сравнительно с типичной длиной строк в чатах). Таким образом,
   общение теряет интерактивность, и пользователь получает возможность
   заниматься своим делом, не отвлекаясь на немедленный ответ (или даже
   просмотр) на пришедшие сообщения, если ему это не нужно. Отпадает
   необходимость быстрого ответа на сообщение, вместо этого оно может
   редактироваться сколь угодно долго (конечно, в разумных пределах).
   Соответственно, инициатива переходит к пользователю, самостоятельно
   планирующему свое время, от его собеседников, вольно или невольно
   принуждавших его к реагированию.</p>
</blockquote>
<p>Сендер, таким образом, получился разумным компромиссом между форумом и
чатом, будучи нащупан совершенно случайно Александровым, когда тот делал
замену WinPopup. К сожалению, эта разница в идеях не была осмыслена, и не
была использована "на всю катушку". Так часто бывает: идея хороша, исполнение
же "как всегда", и может её совершенно испортить. Представьте себе форум, в
котором есть одно только текстовое поле ввода, и больше ничего, и современный
форум, с его кучей смайликов, средств оформления и цитирования, вставки
картинок... Разница в удобстве очевидна &mdash; но по сути своей и то и другое всё
равно будет форумом, а не чем-то другим.</p>
<p>Увы, все реализации сендера и по сей день не обращают внимания на
интерфейс, делая его по принципу "как проще программисту", минимально
работает и ладно. Это частенько и отпугивает новых пользователей &mdash; сендер
кажется чем-то старым и сходу непонятным, неудобным. Тогда как можно было бы,
например, взять интерфейс типа современных клиентов ICQ &mdash; они тоже умеют
многострочные сообщения (но ввиду ориентации на многомиллионную аудиторию,
естественно, не делают их групповыми), скажем, <a href="#img-miranda-historypp">вот
так</a>. Многое можно было бы сделать, кое-что рассмотрено в <a
href="#thsender">последнем разделе</a>. Важно лишь, что идейная основа &mdash;
будет не чатом.</p>
<p class="small" style="text-align: right;"><a href="#toc">назад к оглавлению</a></p>
<a name="spsender"><h2>SPSender</h2></a>
<p>В самом начале 2005 года (зимняя сессия еще только начиналась) Кирилл
Каликин, аспирант, соорудил на базе исходников TCPSender бота-автоответчика &mdash;
тот отвечал на сообщения вида "Кто печатает?" рекламой принтера в комнате 428.
Желание заработать понятно, ведь в сессию печать в общаге весьма актуальна, но
написал своего бота аспирант совсем по-студенчески &mdash; лишь бы как-то работало.
В результате периодически бот отправлял криво сформированные пакеты, от чего у
всей общаги разом сендеры вываливали окно об ошибке, и дальше оставалось
возможным лишь прибить процесс. И так несколько дней подряд, пока его не
вычислили. Каликин, конечно, за такую диверсионную деятельность (сессия, а тут
связь отказывает) получил от админов (а заодно и за спам &mdash; реклама валилась
всей общаге). Но этот случай показал, в дополнение к уже известным недостаткам
TCPSender, что еще и с защитой от злонамеренных пользователей всё плохо.</p>
<p>Сейчас трудно сказать, подстегнул ли именно этот случай, но на зимних
каникулах того же 2005 года Shaddix (Артур Дробинский), Pazalini (Артем
Белоусов) и помогавший им Александр Подлесный &mdash; начали разработку нового
сендера. Все трое &mdash; известные наши олимпиадники, разработка шла быстро &mdash; уже в
конце февраля продукт умел не только базовый обмен сообщениями, но и скачивание
обновлений самого себя по HTTP, смену языка интерфейса на ходу, поддержку
away/autoaway. Разработка велась грамотно &mdash; с самого начала авторы сделали
эскизный проект, куда сразу включили всё необходимое (например, поддержку чата
и пересылки файлов).</p>
<p>Вот как он выглядел:</p>
<table border="0" cellspacing="5" cellpadding="15"><tr valign="top"><td>
<a name="img-spsender-main"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/spsender-main.png"
width="488" height="355" align="center" alt="" title=""></a>
<p class="small">Стиль цитирования такой же; самая правая &mdash; кнопка Connect</p>
</td><td>
<a name="img-spsender-about"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/spsender-about.png"
width="306" height="323" align="center" alt="" title=""></a>
<p class="small">Претенциозное было начинание...</p>
</td></tr><tr valign="top"><td>
<a name="img-spsender-send"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/spsender-send.png"
width="335" height="258" align="center" alt="" title=""></a>
<p class="small">Кнопку очистки набранного приделать не успели</p>
</td><td>
<a name="img-spsender-settings"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/spsender-settings.png"
width="304" height="302" align="center" alt="" title=""></a>
<p class="small">В переводе с украинского на буржуйский, "нема" = "away"</p>
</td></tr></table>
<p>Серверная часть, которую написал Shaddix, представляла собой скрипт на языке
Perl объемом 12 Кб (500 строк), в дальнейшем он намеревался сделать поддержку
сохранения сообщений в базе, что добавило еще пару Кб. Всё шло хорошо, проект
развивался быстро, вплоть до начала в мае сессии у 4 курса. Им пользовалось (в
пиках) до 30 человек (четверть населения TCPSender).</p>
<p>Но... потом проект тихо угас.</p>
<p>Причин тому было две, хотя обе в итоге сводились к одним и тем же
особенностям мышления большинства программистов. Первая &mdash; сервер периодически
падал, по невыясненным причинам. Олимпиадный стиль программирования характерен
написанием большого количества кода "на выброс" &mdash; ему требуется отработать лишь
один раз. В проектах реальной жизни же напротив, нужна поддерживаемость кода,
способность быстро искать и править ошибки, и сохранение этой способности в
долгосрочной перспективе. Поэтому, хоть написан он был и быстро, некоторые баги
попортили жизнь надолго.</p>
<p> Впрочем, это &mdash; не очень большая проблема, понимание приходит с опытом, а
опыт &mdash; дело наживное, вопрос лишь времени. Исправимо. В сентябре Shaddix баг
обнаружил, конечно, но решил заодно и сервер на Си переписать, тем самым еще
раз частично "наступив на грабли" второй причины. Пользователей уже не было,
и даже переписывание не было доведено до конца.</p>
<p>Вторая причина &mdash; это подход "этот код надо выкинуть и переписать всё с нуля,
несовместимым со старым образом". <b>Никогда не поддавайтесь на соблазн сделать
"с нуля" новую, несовместимую со старой систему</b>.</p>
<p>Конкретно в случае SPSender проблема выглядела так: пользователь ставил
себе "новый" сендер, и обнаруживал, что людей в нём всего ничего, почти все,
с кем нужно держать связь, сидят на "старом" (20 человек против 120). В
результате он вынужден держать запущенными сразу оба, периодически наблюдая,
что в новом все пропадают, а его авторы, видимо, не очень заинтересованы в
исправлении проблем. В конечном итоге он не хочет возиться сразу с двумя и
оставляет себе один &mdash; старый.</p>
<p>Точно такая же ситуация наблюдалась и, например, с ICQ &mdash; ею все пользуются,
потому что все контакты там, а другими протоколами &mdash; только энтузиасты. Лишь
когда одна программа начинает уметь сразу несколько сетей, причем удобно для
пользователя &mdash; лишь тогда начались подвижки.</p>
<p>Но это не единственный пример, конечно. Поддавшись соблазну "переписать всё
нафиг с нуля", провалились многие другие проекты. Была когда-то такая компания,
Mozilla, делала одноименный браузер, лидер рынка, между прочим. И вот решили
они, что код стал совсем неподдерживаемым, пора его выкинуть и переписать весь
заново. Процесс растянулся на годы, за это время контора разорилась, а рынок
браузеров захватил IE от Microsoft. Правда, они отдали код сообществу, из чего
потом спустя годы вырос Firefox &mdash; но в те-то годы программисты остались без
работы...</p>
<p>Кто-то может подумать, что это было давно. Увы, примеров таких много. Из
последнего &mdash; громкий провал Google Wave. Они решили создать новую систему для
общения, разрекламировали её. После чего люди обнаружили, что там нет никого из
их существующих контактов, и нет возможности их добавить. Теперь системой
пользуются только энтузиасты, и никакой шумихи уже нет (а то и поговаривают,
что Google и вовсе прекратит этот проект).</p>
<p>Так произошло и здесь. SPSender хоть и был хорошим проектом, был прочно
забыт после сентября 2005 года по, увы, совершенно не техническим причинам.</p>
<p class="small" style="text-align: right;"><a href="#toc">назад к оглавлению</a></p>
<a name="seahist"><h2>SEA Sender: интриги и политика</h2></a>
<p>Зимой 2006 года, в начале семестра, двоих студентов тогдашнего 4 курса (на
курс младше авторов SPSender), Алексея Фадеева (#Kpot#, томич) и Сергея Хилкова
(J7, председатель студсовета общежития) иногда можно было видеть на лекциях с
увесистой книгой П.В. Румянцева "Азбука программирования в Win32 API" в руках
(серьезное руководство, по довольно тяжелым низкоуровневым вещам). А когда
стали таять снега, пользователи единственного на тот момент TCPSender'а стали
время от времени наблюдать картину наподобие вот такой:</p>
<a name="img-tcps-seauser.png"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-seauser.png"
width="653" height="527" align="center" alt="" title=""></a>
<p>Это выглядело как приписка чего-то совершенно нового, хотя, как видно, трюк
достигнут впиской символов в имя компьютера. Но винда такие символы вписывать
не разрешает, TCPSender тоже. Так, без предварительных публичных анонсов,
заявил о себе новый проект, названный авторами SEA Sender (клиент был написан
на MS Visual C++, сервер на Java). Они учли причину провала предшественников
и предприняли значительные усилия для обеспечения совместимости: например,
протокол TCPSender был получен анализом отправляемых им пакетов данных. Такую
же технику применяют и для реверс-инжиниринга ICQ, поскольку официальные
спецификации были закрыты (все, наверное, наслышаны о ситуациях "они обновили
протокол и все неофициальные клиенты теперь не работают!").</p>
<p>Как работала совместимость с TCPSender? Очень просто &mdash; каждый клиент SEA
открывал порты "старого" сендера и отвечал на сканирование, таким образом
присутствуя в списках у старых, а также мог принимать от них сообщения. Сервер
же производил сканирование сети на предмет "старых" сендеров, добавляя их в
список у "новых", и осуществлял им рассылку групповых сообщений из "нового"
сендера. Довольно просто (но, как оказалось позже, имело свои проблемы).</p>
<p>В апреле проект развернулся во всю, и первыми его оценили те страдальцы,
которые сидели за NATами как в общаге, так и в городе &mdash; раньше они не могли
воспользоваться сендером вообще (см. <a href="#tcpsbugs">подраздел о проблемах
TCPSender</a>).</p>
<p>Вот так выглядела одна из относительно поздних версий (скриншотов более
ранних не сохранилось), вместе с окном информации о пользователе:</p>
<a name="img-sea096"></a><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug07.png"
width="588" height="433" align="center" alt="" title="">
<p>Здесь пользователи SEA Sender отображены бирюзовым цветом, а пользователи
TCPSender &mdash; сиреневым.</p>
<p>А вот так выглядели значки всех трех сендеров в системном трее:</p>
<table border="0" cellspacing="10" cellpadding="10"><tr valign="top">
<td align="center">
<a name="img-tray-empty"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/senders-tray-empty.png"
width="106" height="30" align="center" alt="" title=""></a>
<p class="small">Слева направо: TCPSender, SEA Sender, SPSender</p>
</td><td align="center">
<a name="img-tray-msgs"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/senders-tray-msgs.png"
width="106" height="30" align="center" alt="" title=""></a>
<p class="small">Они же, но в каждый пришло сообщение</p>
</td></tr></table>
<p>Одним из других, сразу бросавшихся в глаза отличий, было изменение в стиле
цитирования сообщений при ответе. Если раньше TCPSender разбивал сообщение на
строки по ширине окна и к каждой строке приписывал имя автора, то теперь такое
приписывание делалось лишь вначале абзаца &mdash; а чтоб различать, где чей текст,
ввели строку-разделитель:</p>
<a name="img-sea-main-about"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug02.png"
width="603" height="495" align="center" alt="" title=""></a>
<p>Никто не обратил внимания в то время на такую мелочь, как иконку одного
"человечка" для приватов и нескольких &mdash; для группового сообщения. В TCPSender
так можно было различать сообщения, теперь же приходилось вчитываться.</p>
<p>Кроме того, он гораздо более просто настраивался, чем TCPSender &mdash; достаточно
было указать адрес основного сервера и запасного (на который соединялся, если
не мог связаться с основным):</p>
<table border="0" cellspacing="5" cellpadding="10"><tr valign="top">
<td>
<a name="img-sea-opts-nick"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seasender-opts-nick.jpg"
width="347" height="235" align="center" alt="" title=""></a>
<p class="small">Позволял изменить ник сразу, без переподсоединения</p>
</td><td>
<a name="img-sea-opts-srv"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seasender-opts-srv.jpg"
width="347" height="236" align="center" alt="" title=""></a>
<p class="small">А вот ввести DNS-имя сервера - не позволял...</p>
</td></tr></table>
<p>Однако развивался проект очень медленно. Тогда, весной 2006, он умел только
обмениваться сообщениями. Показанная выше возможность изменения ника появилась
лишь полгода спустя. Сначала не было возможности даже указать о себе какую-то
информацию. Потом она появилась, но её формат был жестко зашит:</p>
<a name="img-sea-opts-info"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seasender-opts-info.jpg"
width="299" height="195" align="center" alt="" title=""></a>
<p>Можно было только выбрать между двумя факультетами, АВТФ и МСФ, указать
комнату, да до 256 символов информации. Городским оставалось только не писать
комнату вовсе &mdash; и это при том, что сам автор был городской, и основной сервер
работал на его машине!</p>
<p>Тем не менее, несмотря на низкую скорость развития, отсутствие поначалу даже
чата, пользователи были довольны &mdash; для некоторых это была единственная
возможность общаться, остальные же просто видели, что процесс идет, и, самое
главное, могли в нем как-то поучаствовать. Здесь проявляется следующий фактор
успешного проекта: <b>необходима обратная связь с пользователями и выполнение
их пожеланий</b>. В сендере разворачивались обсуждения, что надо сделать, как
сделать, предлагались варианты, выбирался какой-то один и реализовывался. И
даже если ваш проект пока еще значительно хуже конкурентов, дайте пользователям
ощутить, что они имеют влияние на разработчиков, и они будут счастливы, несмотря
на все проблемы (тем более, что "конкурент" TCPSender был просто мертв, некому
было развивать).</p>
<p>А проблемы были.</p>
<p>Да, на столь ранней фазе развития многие проблемы часто являются всего лишь
"болезнями роста", и даже не очень прилично о них говорить. Если только они не
затягиваются слишком надолго, а продукт начинает считаться уже взрослым...</p>
<p>Основной сервер, напомним, работал в городе, на машине, с которой выходил и
сам #Kpot#. Альтернативный работал в общаге на машине Хилкова. Реализация
таймаутов была такой, что сендер частенько "отваливался" и переключался на
альтернативный. А вот связи между основным и альтернативным &mdash; не было никакой.
Они не были сетью серверов наподобие IRC-сети. Так что клиенты оказывались
разделены на две части.</p>
<p>Для решения этой проблемы, вместо починки работы с сетью (а работа по Томску
мало чем отличается от общаги, это не внешка), Крот решил перенести основной
сервер в общагу, на основной unix-сервер hostel. Администрацией сети проект,
поддерживающий совместимость с TCPSender, был воспринят положительно, и
Java-сервер был запущен на хостеле.</p>
<p>Тут начала повторяться забавная ситуация. Сервер запускался, работал
примерно 5 дней и падал (причем падал аварийно, в корку). Срок варьировался,
но всё повторялось регулярно. За сервер отвечал Вадим Гончаров (nuclight),
техник актива AVTF.Net, проследив за процессом сервера в очередной раз, он
увидел, что при запуске размер виртуальной памяти сервера составляет чуть
более 200 Мб (и подивился, чего так много для такой сравнительно простой
задачи). Затем размер постоянно растет, упирается в административный лимит
256 Мб &mdash; после чего процесс аварийно завершается. На машине Крота проблема,
понятно, возникать не успевала (чаще сервер апдейтился для новых фич), потому
что на сервере не было лимитов, ибо ему не нужно было обслуживать кучу других
задач для всей сети.</p>
<p>Это было похоже на явную утечку памяти, и чтобы удостовериться, что здесь
проблема не JVM, nuclight 26 мая сходил на канал #java в RusNet, задав там этот
вопрос. На что получил ответ "если память у жабы кончается, это 98% программера
проблема" и совет передать программеру гуглить по "java memory leaks", мол,
имеется ряд статей.</p>
<p>Что и сделал. Удивительно, однако, что ничего не изменилось. Впрочем, здесь
можно было бы сказать &mdash; "сессия!", но ничего не изменилось ни летом, ни осенью.
Хуже того, каждые 5 дни Крот логинился на хостел и перезапускал сервер вручную.
В таких случаях, если нет времени и желания, стандартные, доступные рядовому
пользователю средства Unix легко позволяли соорудить "костыль" &mdash; автоматический
перезапуск при падении. Проблему не устраняет, но нет хотя бы downtime (времени
неработы), пока сервер лежит, и это еще не починено. Но не было сделано даже
этого, Крот продолжал делать всё вручную.</p>
<p>К тому времени было видно, как медленно проект развивается &mdash; SPSender за
гораздо меньший срок уже обладал более полной функциональностью. Как не
решается проблема сервера. Как выбираются решения похуже, но попроще &mdash; есть
подозрение, например, что менее удобное цитирование со строкой-разделителем
было алгоритмически сделать проще, чем более удобное у TCPSender. Насмотревшись
на всё это, nuclight решил исследовать вопрос, как можно принципиально улучшить
сендер, чем и занялся в июле, уехав на каникулы.</p>
<p>Разработчики же за лето сделали не так много &mdash; закончили чат да приделали
архив сообщений (ведется с 18 августа, доступен и сейчас). Архив был сделан на
Web &mdash; в меню программы выбирается пункт, открывается браузер со страницей, на
которой доступны все публичные сообщения. Так была решена проблема "повторите
кто что писал, у меня сендер вылетел", а также тех, у кого был выключен
компьютер. Архив стал первым существенным новшеством, которое SEA Sender
привнёс по сравнению со своими предшественниками.</p>
<p class="small" style="text-align: right;"><a href="#toc">назад к оглавлению</a></p>
<a name="seautumn"><h3>Осеннее обострение</h3></a>
<p>Всё началось в конце августа, когда народ в основном вернулся с каникул.
Сендер был улучшен, например, добавилось удаление только прочитанных. Мало кто
заметил, однако, что новая версия принудительно убивала процесс TCPSender,
таким образом, держать оба сразу теперь не представлялось возможным. В то же
время начинается бурление &mdash; число пользователей нового приближалось к числу
пользователей старого, была уже примерно половина. В связи с чем от наиболее
активных энтузиастов стали поступать предложения всем перейти на новый, сделав
его официальным. Все эти бурные дискуссии сохранились в архиве за 2006 год
(каждый может перечитать при желании), поэтому эту историю можно изложить более
подробно.</p>
<p>Разработчики сендера почувствовали силу и стали вести себя менее
корректно. Например, одним из наиболее популярных вопросов в сендере был
"кто печатает?", на втором месте шли объявления о продаже внешки. И если
о печатниках Крот (почти всегда от имени разработчиков писал он) согласился
подумать, то на предложение сделать визуальную индикацию и провайдеров
внешки ответил "жирно будет". Аналогично (хотя более вежливо) он ответил и
на просьбу сделать в чате поддержку <tt>/me</tt> и оставление окна чата
открытым, если с той стороны его уже закрыли (закрывалось и тут, можно было
не успеть переписать). Последнее, впрочем, позднее было сделано как
доступный в меню лог последнего чата.</p>
<p>Поддержку списка отосланных сообщений (как <a href="#img-tcps-sentmsgs">это
было в TCPSender</a>) он обещал, но так никогда и не сделал. Аналогично
24 сентября была обещана поддержка пересылки файлов, которая тоже никогда
не была сделана.</p>
<p>Хуже стало и с починкой багов. Сообщили, что при наборе ответа в привате
по непонятным причинам уходит пустое сообщение на всех и закрывается окошко
набора сообщений &mdash; после разбирательства всё же подтвердили, что это все таки
баг, но делать ничего не стали. Цитирование иногда не подставляло ник, с этим
тоже бороться не стали.</p>
<p>Вместо этого общественность всё более была занята обсуждением, что "нас уже
много", и пора бы уже "всем перейти на новый". Отдельные наивные энтузиасты
даже выдвигают предложение "в полночь всем разом взять и перейти". Естественно,
ничего такого не произошло &mdash; да и не могло. К сожалению, они не осознавали
полностью, почему нужна совместимость, и считали, что раз количество перевалило
за половину, то она более не нужна. Увы, никто не привел сравнения с
коммерческими программами, где даже 20% рынка &mdash; это значительный кусок. Ведь
сендер-то был некоммерческий... Однако принципы поведения пользователей при
этом неизменны (например, браузеры уже много лет бесплатны, тем не менее, речь
о проценте рынка вполне идет).</p>
<p>19 сентября Kim (Алексей Лепустин, одногруппник Shaddix'а, тоже олимпиадник)
выступает против SEA Sender'а за приваты: из старого в новый можно писать
в приват, но нельзя отвечать в приват. Однако невозможно из нового сендера в
приват старому написать. По этой причине он вынужден оставаться на старом &mdash; так
с ним смогут связаться все, а не только те, кто пользуются SEA (он печатник, и
для него это важно &mdash; влияет на уровень доходов, понятное дело). То же самое, и
даже в большей степени, применимо и к активу сети &mdash; в дискуссии встрял nuclight.
К сожалению, им не удалось донести свою точку зрения до противоположной стороны.
Оппоненты не поняли, что гарантированная связь в обе стороны суть проблема не
пользователя с той стороны, а того же актива. Если б актив перешел на SEA, и
ему пишет пользователь со старого, пишет с проблемой &mdash; надо иметь возможность
ему ответить. Потому что нельзя <i>заставить</i> всех пользователей перейти на
один и тот же клиент.</p>
<p>Кроме того, в этот день поступил ряд интересных предложений по группам &mdash; в
старом сендере они были, тут не было. А было бы удобно. Но они остались
проигнорированы разработчиками.</p>
<p>20 сентября, наблюдая кучу флуда, интересного далеко не всем, Shaddix
предложил сделать сообщениям приоритеты. Это была отличная мысль, актуальная и
поныне &mdash; пользователи сендера делятся на тех, кто не прочь пообщаться, и тех,
кто хочет читать только объявления. Но, к сожалению, и на эту идею никто не
обратил внимания. В тот же день Kim сообщает, что у него глючит и прямая
отправка (неработавший ответ можно было заменить написанием нового двойным
щелчком в списке, новый сендер уже начал обзаводиться собственными способами
обхода багов).</p>
<p>21 сентября, чтобы не было всего этого флейма, предложили сделать голосование
прямо в интерфейсе сендера. Разработчики ответили, что проще сделать страницу
на php, но не сделали даже и её.</p>
<p>22 сентября поступает жалоба: мол, у всех нормальных людей если в программе
что-то изменилось &mdash; меняется версия, тут же под одной версией 0.9.6 гуляет куча
разных вариантов. В самом деле, запутывающий пользователя подход. Кроме того,
подняли вопрос про разделители цитирования (ту самую -==-==- между цитатами) &mdash;
многим она была неудобна. Мнения разделились. Поступило и третье решение, самое
правильное (потому что так делают почтовые клиенты) &mdash; выделять цветом цитаты
разных людей разным цветом. #Kpot# же сказал так: &laquo;Хотя бы человек 10
остановится на одном и том же &mdash; сделаю&raquo;. Звучит как гарантия, но с
учетом того, что их всего-то в обсуждении участвовал десяток, этого опять-таки
никогда не произошло.</p>
<p>В тот же день Алексей Алыков (Muzzy), аспирант, занимающийся компьютерной
безопасностью, заинтересовался "косяками" SEA Sender'а. Никто не придал тогда
этому значения.</p>
<p>23 сентября выходит версия 0.9.7: в ней добавилась возможность смены ника,
иконка в трее стала серой, если все сообщения были прочитанными. Но самым
важным нововведением были "Печатники" &mdash; еще одна группа, сообщения которой
доставлялись тем, кто в ней состоял. Добавить себя в неё можно было, нажав на
панели инструментов кнопку со значком принтера. Однако визуальной идентификации
печатников в интерфейсе никакой не было &mdash; пользователь вынужден был отправлять
им вопрос вслепую. Гораздо более корректным решением, на самом дело, было бы
ввести фильтрацию в клиенте по ключевым словам &mdash; печатники могли бы на это
реагировать, а сендеры остальных могли бы такие назойливые сообщения просто не
показывать. Тем более, что задание подстрок для поиска тривиально расширяется и
для любой другой подобной потребности. Здесь же для каждого такого случая всем
пришлось бы обновлять клиент (не говоря уже о сервере и поддержке в протоколе).</p>
<p>Еще в этот день была поднята тема, зачем нужна защита архива. Дело в том,
что к урлу каждый раз приписывался уникальный 4-значный id, если он был
некорректен, то архив нельзя было просмотреть. Был получен ответ: чтоб могли
просматривать только пользователи SEA. Дескать, конкурентное преимущество.
#Kpot# пообещал: &laquo;После отключения совместимости уберу. Ближайшее время
будет действовать то и другое&raquo; (впрочем, 24 сентября он и пересылку
файлов пообещал). Но выполнил обещание только через несколько месяцев. На что
nuclight ему заметил, что организовать чтение архива в принципе &laquo;может
сделать любой пользователь с хомой на хостеле, без всяких админских прав&raquo;.
Но Крот не понял, каким образом. В следующем подразделе будет описано, как.</p>
<p>25 сентября началось всё самое интересное. Сначала вылез баг, когда в списке
один человек появился кучу раз. Как выяснилось, у него глючила сеть &mdash; клиент
входил много раз. Решили проблему несколько криво &mdash; просто ограничили число
входов с одного адреса. Теперь, когда у человека проблема исчезала, он был
вынужден ждать, пока "фантомы" не исчезнут &mdash; до тех пор его не пустит. Случился
и другой глюк сервера, наблюдавшийся потом время от времени еще пару лет:
Shaddix задал о нем вопрос &laquo;А почему меня нет у меня в списке и
сообщения, отправленные мной, подписываются другими юзерами?&raquo;. Видимо,
пользователей SEA стало слишком много, и нагрузка выявила доселе "дремавшие".
<p>Позже начались глюки с кучей Muzzy в списке. Но у него глюков сети не было.
А потом... потом в сендере внезапно оказалась 1000 сообщений. Как выяснилось
позже (не публично), это Muzzy (помните его вопросы несколькими днями ранее?)
"поигрался" с новым сендером. Никакой защиты от злоумышленников, флуд-контроля,
подобного тому, что на IRC-серверах, предусмотрено не было. Muzzy эксперименты
с подобным публичным исходом более не повторял (хотя кто знает, что он делал
незаметно), чтобы не "засветиться".</p>
<p>Но разработчики, видимо, не поняли, что именно произошло. Здесь они допустили
ошибку: <b>в проблемах с безопасностью следует разбираться, чтобы тот же
способ нарушения не был использован еще раз</b> (и спустя полтора месяца это
таки вышло им боком). К сожалению, они не стали разбираться (и вообще фиксить
баги), а пошли наиболее простым путём:</p>
<blockquote>21:43:13 25 сентября 2006 #Kpot#[FreeWay]:<br>
Для уменьшения глюков поддержка старого сендера отключена.<br>
В ближайшие дни мы полностью перепишем сервер, тогда все глюки точно исчезнут
</blockquote>
<p>26 сентября вышел SEA Sender версии 0.9.7.3 &mdash; но исправлено было только
несколько багов, не более того.</p>
<p>27 сентября было обсуждение, когда окно сендера при получении сообщения
следует разворачивать из трея. Проскочило предложение "когда в сообщении есть
твой ник", которое снова не было услышано. Выше уже упоминался способ решения
проблемы печатников фильтрацией сообщений по текстовым подстрокам &mdash; им можно
было бы решить и эту потребность. Кроме того, было обещание версии сендера со
встроенным браузером. Излишне упоминать, что это так же никогда не было
сделано.</p>
<p>28 сентября снова обсуждали, что всё равно много кто спрашивает про печать в
общак, несмотря на печатников. Пока что сошлись на том, что не все еще поставили
себе новую версию. Юзеры стали задавать вопросы, почему поддержка старого
сендера отключена, там же еще был народ, объявления по срокам оплаты, например.
Ведь актив сети остался на старом сендере &mdash; в том числе по причине того, что
два одновременно запустить было нельзя (SEA Sender убивал процесс старого). На
что #Kpot# ответил, что там осталось меньше 10 человек. На самом деле их было
больше, так как он смотрел из города (не учел <a href="#tcpsbugs">проблемы</a>
старого сендера, мешавшие адекватному подсчету всех). А также высказался в духе
"Вадима жаба давит", и другие оскорбительные высказывания для администрации
сети в целом.</p>
<p>На что администрация сети просто молча забанила его IP от всей сети общаги.
Сервер сендера на хостеле продолжал работать. Но, как ранее уже было описано,
никакой автоматизации предусмотрено не было, проблема с утечкой так и не была
решена. И через день он просто упал, а Крот был не в состоянии его поднять (или
же попросить сделать этого кого-то в общаге). Причем альтернативный сервер на
тот момент был в городе, в результате с 30 сентября по 5 октября 2006 те, кто
перешел на SEA, сидели без связи. Некоторые вернулись на TCPSender.</p>
<p>Через несколько дней разработчики SEA Sender выяснили, что произошло, и
договорились о встрече с администратором (YaM_DJ, Михаил Яговкин). В комнату
506, где присутствовал администратор и актив, пожаловала целая делегация,
кроме обоих разработчиков, там еще были Shaddix и Вадим Дашкевич (Sandman), а
также некоторые другие энтузиасты, но лишних попросили удалиться.</p>
<p>Разговор был долгим.</p>
<p>Разработчики считали, что SEA Sender должен быть принят как официальное
средство общения пользователей в сети (на которое ссылался бы Устав) и что
сервер SEA должен находиться на хостеле. Администрация сети считала, что
SEA Sender не готов в качестве такой замены &mdash; еще не реализована часть
возможностей, не устранен ряд проблем. А потому в настоящий момент принят он
не будет, до тех пор же, пока он не станет удовлетворять условиям, обязательна
поддержка старого сендера (для хостинга сервера на хостеле). Существенной
проблемой являлся вопрос также безопасности: исходники SEA были закрыты, автор
жил не в общаге, а в городе, и программа уже была замечена в двух случаях
несанкционированного поведения &mdash; убивание процесса TCPSender без спросу, а
также управляющие команды клиентам через сервер (разработчики использовали их
для смены IP альтернативного сервера клиентам). Не было никаких гарантий, что
подобных "закладок" не найдется еще &mdash; и администрация подчеркнула, что для
деканата хватило бы уже вышеуказанного, если что. Админская паранойя, кстати,
их не подвела &mdash; через месяц был обнаружен баг с переполнением буфера, который
потенциально мог бы быть использован для удаленного исполнения кода...</p>
<p>Затрагивали вопрос и других багов. Утечки памяти в сервере разработчики
объяснили тем, что треды сканирования старого сендера иногда "подвисали", и они
не знали, что с этим делать. Но и принципиально не хотели фиксить этот баг.</p>
<p>В конце концов решили так: разработчики SEA Sender обязуются устранить
убивание старого сендера, чтобы пользователи могли пользоваться обоими, могли
свободно выбирать. Новый сендер пусть развивается, но с сервером не на хостеле,
раз поддержки старого не будет &mdash; когда станет готов, пусть приходят снова.
Вадим Дашкевич (Sandman) из комнаты 310 поднимает сервер и сайт проекта на
своей машине, администрация же выделяет ему дополнительное имя sea.avtf.net
(что делалось редко для кого). На том и порешили.</p>
<p>В конце, перед тем, как все разошлись, Крот, к его чести, признал, что да,
в программе существует ряд проблем. Остальные этого не признали.</p>
<p class="small" style="text-align: right;"><a href="#toc">назад к оглавлению</a></p>
<a name="seavtfnet"><h3>Холодная война и железный занавес</h3></a>
<p>На том всё затихло. Администрация сети и еще некоторое количество юзеров
остались на старом сендере, остальные с 5 октября стали жить на новом. Бурных
дискуссий теперь почти не было, "революция" прошла.</p>
<p>Но разработчики SEA соглашения выполнять не торопились &mdash; версии, которая бы
давала TCPSender'у жить спокойно, выпущено не было ни сразу, ни через два дня.
Зато был с помпой открыт сайт сендера на базе стандартного движка DLE, но и на
том ничего толком не работало, кроме комментариев к новостями и скачки
дистрибутива. Планировался форум, но пока он был недоступен. Даже архив &mdash; и тот
по-прежнему открывался только из SEA Sender, несмотря на обещание от 23
сентября убрать его после отключения совместимости.</p>
<p>Справедливо рассудив, что слово надо держать, а коль, не держишь, так это
дает право на ответные действия, администрация соорудила для себя простенький
CGI-скрипт, позволявший читать архив без запущенного сендера:</p>
<blockquote><pre><font color=#696969>#!/bin/sh</font>

id<font color=#808000>=</font><font color=#0000e6>`nc sea </font><font color=#008c00>8733</font><font color=#0000e6> | cut -b </font><font color=#008c00>1</font><font color=#0000e6>-</font><font color=#008c00>4</font><font color=#0000e6>`</font>

<font color=#800000>exec</font> cat <font color=#808000>&lt;&lt;</font> EOF
Content<font color=#808000>-</font>Type<font color=#808000>:</font> text<font color=#808000>/</font>html<font color=#800080>;</font>

<font color=#90029a>&lt;html&gt;</font><font color=#90029a>&lt;head&gt;</font><font color=#90029a>&lt;title&gt;</font>SEA Sender Archive Link Generator<font color=#90029a>&lt;/title&gt;</font><font color=#90029a>&lt;/head&gt;</font><font color=#90029a>&lt;body&gt;</font>
<font color=#90029a>&lt;a href=</font><font color=#0000e6>"</font><font color=#0000cc>http://sea.avtf.net/archive/archive.php?id=</font><font color=#007997>$id</font><font color=#0000e6>"</font><font color=#90029a>&gt;</font>SEA Sender Archive<font color=#90029a>&lt;/a&gt;</font><font color=#808000>.</font>
Reload this <font color=#808000>.</font>cgi page if link is not valid<font color=#808000>.</font><font color=#90029a>&lt;/body&gt;</font><font color=#90029a>&lt;/html&gt;</font>
EOF</pre></blockquote>
<p>Здесь в двух строках полезной нагрузки делался коннект к серверу на порт
8733 (основной сендер работает на порту 8732), и получалась строка, из которой
вырезалось 4 символа id (их там было два &mdash; текущий и предыдущий). Отдавался он
сервером php-скриптам архива, те пускали пользователя по любому из двух. Просто
беспечные авторы оставили его открытым всему миру &mdash; что ж, не стоило бездумно
хвастаться своей защитой вместо реальных дел.</p>
<p>Впрочем, ничего интересного по теме сендера там почти не происходило. Позже,
однако, разработчики позволили себе дерзость &mdash; на IP-адреса актива определенное
время вместо архива отдавалась страница 403 с изображением среднего пальца. На
случай, если бы актив таки запустил SEA Sender, видимо. Администрация не стала
реагировать на эту совсем уж детскую выходку. Спустя месяц сами одумались и
убрали.</p>
<p>А вот что-то более полезное делать не спешили. 7 октября их спросили про
неработающий форум на сайте. Форум заработал только 24 числа. 8 октября на
арене появляется Семён Тян (Peek), один из героев дальнейшего повествования. Он
сначала вполне поддерживал авторов, 19 сентября выразил им публичную
благодарность, поддерживал предложение всем взять и перейти разом. Теперь же,
похоже, его мнение постепенно начало меняться. Итак, 8 октября он начал кидать
длинные сообщения, видимо, чтобы посмотреть, каков лимит. Кроме того, в этот
день снова наблюдались глюки с никами &mdash; а ведь поддержка TCPSender уже была
отключена, утверждалось, что глюки вызывала именно она.</p>
<p>14 октября Peek спрашивает, где задать вопросы разработчикам, и не получает
ответа.</p>
<p>21 октября было несколько событий. Снова кто-то задавал вопросы, почему его
в списке "двое". На сцене появился Михаил Логинов (Мишаня[AMD]), активист сети,
живший в одной комнате (307) с Семёном (Peek). Единственный из актива, кто на
тот момент использовал SEA Sender. Он сообщает о баге: &laquo;когда жмешь
ответ и начинаешь чепятать то любой кейпрес воспринимается как
ctrl+enter&raquo;. Человек он вспыльчивый, и его раздражение на баг вылилось
в кучу пустых сообщений на группу.</p>
<p>Кроме того, актив в этот день, после полутора месяцев напряженной работы,
ввёл в строй телевещание по сети. Специально для этого случая nuclight запустил
SEA Sender, чтобы сообщить о новости, и не преминул пнуть разработчиков за то,
что он тут ненадолго, потому что одновременно два сендера держать запущенными
невозможно, несмотря на обещание выпустить такую версию и приватное напоминание
об этом разработчикам в середине месяца.</p>
<p>Публичное напоминание, видимо, возымело действие, и 23 октября Sandman
сообщил о выпуске SEA Sender 0.9.7.4 &mdash; версии, которая на самом деле стала
последней. Да, теперь стало возможным держать запущенными оба сендера сразу. Но
никаких других улучшений и даже исправлений ошибок в ней не было, кроме правки
таймингов коннекта для городских пользователей.</p>
<p>А баги проявились, причем и еще доселе невиданные. Сначала 25 октября сервер
стал надолго лагать, и потом разом выплевывать все сообщения в одну секунду.
Задержка достигала десятков минут! У клиентов же случались вылеты при звонке в
чат. Затем 27 октября, кроме Семёна и Мишани, уже и другие пользователи начали
подтверждать, что есть баги. Вспомнили и про давно обещанную кнопку перехода по
ссылке. Да-да &mdash; в SEA Sender всех версий необходимо было каждый URL выделять
мышью и вручную копировать в браузер. И если в 1998 году Интернета в общаге
скорее не было, чем был, и TCPSender имеет оправдание, то в новом &mdash; это просто
неудобно. Тем не менее, 27 октября Peek всё еще считал SEA Sender лучше.</p>
<p>30 октября снова поступили жалобы "гонит сендер", "жрет мессаги". Никакой
реакции. Более того, Мишане приходилось притаскивать Дашкевича пешком и
показывать ему, что баг на самом деле есть &mdash; разработчики иначе просто не
верили.</p>
<p>2 ноября Peek и Мишаня начали играться с ограничениями на символы в нике. И
Мишаня получил бан за то, что оказался первый в списке &mdash; #Kpot# соперничества в
таких мелочах не терпел, и его ник обычному пользователю было ввести в
настройки невозможно.</p>
<p>Столь детская выходка получила детский же ответ &mdash; 3 ноября Мишаня начал
демонстративно писать с разными неудобоваримыми никами (он из таких людей, кто
в ответ на ограничения только распаляется). И 5 ноября получил за это бан на
неделю.</p>
<p>9 ноября Peek спросил: &laquo;а кто нить мне может дать ответ на
вопрос какого это фига при невыделнном ни нике ни группе при нажатии на ЕНТЕР
сендер предлогает мне запостить мессадж а?&raquo;. Баг подтвердил не только
Семён.</p>
<p>10 ноября #Kpot# пишет насчет оскорблений и матов в сендере, дескать, его
месяц назад забанили вообще без мата, и теперь он будет банить в сендере на
свое усмотрение, &laquo;пока актив сети не "признает" SEA сендер&raquo;. На
этом фоне уже незамеченными прошли баг-репорты о <a href="#img-seabug07">заднем
фоне окна информации о пользователе</a> и возможности печатать в общей части
окна чата...</p>
<p>13 ноября #Kpot# объявил:</p>
<blockquote>
В SEA Sender'е есть ограничение на использование символов в никах. Однако,
некоторые товарищи нашли, как обойти ограничение, влезая в файлы
конфигурации. Отныне такие действия будут пресекаться, а данные товарищи &mdash;
получать баны
</blockquote>
<p>Здесь разработчики допустили сразу две ошибки, сродни той, что обсуждалась
ранее, по безопасности. Одна &mdash; это то, что <b>не следует заведомо бессмысленно
ограничивать пользователя &mdash; найдутся такие, которые захотят "восстановить
справедливость"</b>. А если программа распространяется по всему Интернету,
вероятность, что среди них найдутся способные причинить ущерб, уже не так мала.
Другая ошибка: <b>все проверки данных на корректность в сетевых приложениях
следует производить на сервере, потому что злонамеренный пользователь может
взломать клиент или вообще написать свой</b>. В данном случае сочетание сразу
двух этих ошибок привело к тому, что, по-видимому, Семён[Peek] вконец обиделся
на такое отношение разработчиков, и занялся непосредственно протоколом и
сервером.</p>
<p>Первая его попытка была неудачна &mdash; 14 ноября Peek получил бан по IP за
неудачно засланные данные по telnet к серверу. Мотивировка была "за эксперименты
над стабильностью сервака". Однако здесь разработчики должны были сделать и
еще один вывод: раз сервер нестабилен, надо это исправить, пока "хакер" еще
сидит в бане и не угрожает. Потому что это, фактически, проблема безопасности.
По сути, они повторили ту же ошибку, что и в сентябре: <b>не следует
игнорировать проблемы безопасности и сообщения о них</b>. И расплата не
заставила себя долго ждать.</p>
<p class="small" style="text-align: right;"><a href="#toc">назад к оглавлению</a></p>
<a name="seahack"><h3>Почти детективная история</h3></a>
<p>Как позже вспоминал Семён, этот бан его "выбесил", и он стал копать сначала
с другой стороны. Он самостоятельно нашел еще один способ чтения архива без
ссылки из клиента: оказывается, достаточно было просто выставить переменную в
active=1 в POST-запросе. Подивившись простоте, Peek решил попробовать самые
элементарные уязвимости, которые встречаются в Вебе.</p>
<p>Сервер (как узнали позже) дописывал сообщения (окружив их тегами) прямо в
статические php-файлы, которые читались основным скриптом. Никакого
экранирования символов в сообщениях он не делал. В результате скоро читатели
архива увидели в нем порнографические картинки &mdash; некто с именем компьютеров с
кафедры ВТ отправил сообщения с тегами <tt>&lt;img&gt;</tt>. И они были
показаны. Атака довольно безобидная &mdash; потому что таким образом и JavaScript
можно включить. Семёна, однако, заметила на кафедре однокурсница, имевшая в
сендере ник <acronym title="по прозвищу &laquo;Страшная&raquo;, что дали ей
на потоке">"Ленуся"</acronym>. И конфликт получил новый виток.</p>
<p>Чтение и исполнение PHP-файлов, однако, тоже было сделано из рук вон плохо.
Проблемы с безопасностью &mdash; вообще распространенное явление среди проектов на
PHP, тем более, что <a href="/~vadim/phpbastard.html">сам язык PHP на это
провоцирует</a>... И Семён, найдя ляп, который можно было эксплуатировать для
получения контроля над сервером, задумал страшную месть.</p>
<p>Дальше события развивались совсем как в шпионском романе.</p>
<p>В субботу, 18 ноября, должно было состояться официально посвящение АВТФ, в
концертном зале в Облсовпрофе. Все, наверное, знакомы с ним &mdash; каждая кафедра
готовит номера в стиле КВН. Праздник потом продолжается всю ночь в общаге, с
горячительными напитками. Время для диверсии &mdash; просто идеальное, при всеобщем
веселье кому какое дело до работы каких-то серверов?..</p>
<p>Посвящение начиналось в 6 вечера. Перед ним Peek отправился в близлежащий (к
месту Посвящения) компьютерный клуб. В самом деле, надо же заметать следы, ищи
потом ветра в поле, когда логи ведут на публичный компьютер?.. Но разведку
местности Семён не провел, и только потратил время зря &mdash; в этом клубе нельзя
было запустить своих программ с флэшки (а попробовать что-либо с вырубленным
эксплорером не позволяло время). Пришлось пойти на Посвящение и сидеть там,
обеспечивая алиби ("я там был, меня видели, вот, подтвердят").</p>
<p>Досидев до середины, в один из удачно рассчитанных моментов, когда внимание
зрителей было приковано к сцене, Peek вышел из зала, и, надвинув на глаза
капюшон, двинулся в другой компьютерный клуб, "Nettown".</p>
<p>Там он сделал своё дело &mdash; контроль над сервером был получен. И возможность
читать всю файловую систему &mdash; а сервер крутился на винде, на домашней машине
Sandman'а. В частности, Peek утащил весь архив сообщений к тому моменту (позже
это сослужило хорошую службу &mdash; только благодаря этому сейчас в архиве есть
сообщения за 2006 год) и скомпилированный сервер сендера (толку с этого было
мало, ибо не исходники). Но много ли возьмешь с одного раза? Peek попытался
залить на сервер веб-шелл, чтобы иметь возможность контролировать его и потом.
Тут начались проблемы &mdash; из-за той самой переменной шелл не хотел работать
корректно, пришлось впопыхах его править. В конечном итоге всё прошло успешно,
и Семён благополучно вернулся в общагу.</p>
<p>Прошло 2 дня. Никто ничего не заметил.</p>
<p>Но шпионы, как известно, попадаются на мелочах.</p>
<p>У Семёна взыграло тщеславие, и он решил добавить еще. Ранее он анализировал
протокол путем перехвата трафика, этого не хватало на всё, но было
достаточно, чтобы написать простенькую программу, могущую соединиться с
сервером и отправить заранее подготовленное сообщение.</p>
<p>Такая программа была подготовлена, 21 ноября в обед Peek вновь отправился
в Nettown, залил на чужой FTP в ТУСУРе свою программу, а в incoming на хостеле
положил файл <tt>"Фотки с посвящениЯ.url"</tt> &mdash; расчет был на любопытного
пользователя (а в это время народ уже отходил с бодуна и как раз начинал
выкладывать, спрос был высок), и он оправдался с лихвой.</p>
<p>Семен пришел домой и лег спать. Проснулся вечером &mdash; общага гудела. В сендере
то один, то другой пользователь слал сообщение "Сэндман дурак!!!" и HTML-код,
ведущий на порнокартинки (сервер, правда, к тому времени уже пофиксили, XSS
больше не работал). Все гадали, что это может быть, разработчики сендера
предположили, что кто-то меняет IP-адреса (не очень обдуманное предположение,
поскольку скорость была высокой, и нарушитель сразу был бы вычислен админами
сети). Активу пришлось побегать по пользователям, было установлено, что это
делает программа, имевшая в девичестве название SenderButNotReceiver.exe. Был
выяснен и источник &mdash; .url-файл на FTP-сервере общежития. Анализ логов показал,
откуда он был залит, и куда вёл.</p>
<p>У разработчиков SEA Sender были подозрения, что это сделал Peek, но не
было доказательств. Получив сведения от администрации сети, они принялись за
дело, и на следующий день знакомые Snadman'а в Nettown'е предоставили ему
фотографии с камер видеонаблюдения, где Семён &mdash; увы &mdash; был со снятым
капюшоном, лицо опознать не составляло проблем.</p>
<p>К Семёну в комнату пожаловал и актив, и разработчики. В инциденте он
сознался, за надпись от программы извинился, а заодно рассказал и про взлом
сервера. Такого поворота событий разработчики, мягко говоря, не ожидали. В
какой-то степени, можно сказать, Peek своей цели добился. И получил максимально
возможное по Уставу сети наказание &mdash; месяц полного отключения. Но больше
никакие взломы хозяев сервера SEA Sender не беспокоили.</p>
<p>На том все страсти по сендеру в общаге бушевать перестали.</p>
<p class="small" style="text-align: right;"><a href="#toc">назад к оглавлению</a></p>
<a name="seasunset"><h3>Времена упадка и запустения</h3></a>
<p>Да, разработчиков больше никто не трогал, они тоже больше ничего не делали.
Но стоит пояснить некоторые моменты.</p>
<p>3 ноября Крот пишет, что, дескать, Вадим (nuclight) сам пишет сендер третий
год, и потому так нападает, что обидно ему. Вадим действительно к тому моменту
уже писал свой сендер, но не третий год, а еще и месяца не прошло. Ранее
упоминалось, что в июле он начал исследовать вопрос. Вылилось это в
документ-спецификацию, который был закончен в октябре. Актив сети не имел
привычки выпускать продукт, который был бы еще совсем сырым, а не имел уже
достаточно высокое качество и был пригоден к использованию. Так, в сентябре был
сделан новый сайт хостела (который остался таким и поныне), актив переключился
на вещание телевидения по сети &mdash; после напряженной работы 21 октября оно было
запущено. Затем каждый занялся своим делом &mdash; админ Михаил Яговкин (YaM_DJ) стал
разрабатывать следующую версию сайта, Мишаня поддерживал файловый архив и
занялся улучшениями TV-клиента, Вадим почти дописал протокол и переключился на
написание сервера нового сендера.</p>
<p>И всё это помимо основных обязанностей и прочей жизни студентов. Например,
Вадим еще помогал 2 курсу с организацией Посвящения АВТФ. В результате сервер
был закончен через несколько недель, потом был начат клиент. Но всё это
делалось в одиночку (в отличие от всех предыдущих клиент-серверных попыток, где
всегда участвовала команда минимум из двух человек). В результате был набросан
лишь эскиз клиента, а потом началась сессия. А после нового года и YaM_DJ, и
nuclight устроились на работу &mdash; и как новый сайт хостела, так и новый сендер
(подробнее о нем будет <a href="#thsender">соответствующем разделе</a>) &mdash; увы,
навсегда остались недописанными.</p>
<p>Но на волне некоторой необычности взлома сендера и общей теме сендера,
nuclight заинтересовался, что это за хакер такой. Так они с Семёном и
познакомились, и Peek был единственный, кроме актива, кто увидел зачатки
нового клиента. И позже занялся конструктивной деятельностью.</p>
<p>Ибо было чем &mdash; совершенно неожиданно (для обитателей сендера) Sandman сдал
сессию и уехал на преддипломную. Сайт сендера и архив внезапно прекратили своё
существование. Сервер потом полгода мыкался то у его сокомнатника, то у
Shaddix'а. А архива не было совсем. Семёна такое положение дел не устраивало, и
он получил домашний каталог на хостеле, где разместил свой собственный архив.
Сообщения он туда помещал самописным клиентом &mdash; наработки по протоколу-то были.
Этот архив просуществовал с 6 января по 17 июня, и тоже доступен сейчас в
основном архиве.</p>
<p>Но архивом Peek не ограничился. Он сделал веб-форму отправки сообщения в
сендер, для тех, например, кто был на кафедре и не имел там установленного
сендера. Сделал клиента-бота, который умел сообщать погоду. И, конечно же, стал
писать (на Delphi) взамен "глючного штатного" писать свой собственный клиент,
назвав его BlastCore Sender.</p>
<p>4 февраля 2007 года вышла первая версия BlastCore. Она еще ничего толком
не умела, но можно отметить некоторые интересные решения, которые в ней были
сделаны. Если все предыдущие сендеры были просто клонами TCPSender, то в
BlastCore, например, Peek отказался от показа списка сообщений в combobox
(выпадающем списке). Теперь они были представлены на отдельной панели в
табличной форме, и можно было, например, выделить галочками несколько сообщений
сразу.</p>
<p>В апреле BlastCore стал поддерживать чат (правда, пока еще только с одним
человеком за раз), и научился сворачиваться в трей &mdash; заодно добавилась новая
интересная возможность, показывать пришедшее сообщение прямо над треем, как это
делают, например, современные клиенты ICQ. 30 мая был публичный анонс в сендере,
и в начале июня вышла последняя версия 0.1.13, после которой началась
дипломная пора, и BlastCore остался недоделанным очень надолго, поскольку
потом Семён закончил ТПУ и уехал.</p>
<p>Осенью проблема размещения сервера возникла вновь, ибо все его хостеры
позаканчивали, а администрация по-прежнему была против. Знакомый Крота
Bisaram (Евгений Чернявский), тоже городской, поднял сервер на своем ADSL. Это
решение оказалось не лучшим &mdash; сендеры в общаге стали частенько вываливать
сообщения об ошибках с сокетами. Разработчик (на тот момент Крот остался один,
будучи на 6 курсе магистратуры, а Сергей Хилков уже закончил ТПУ) объяснял это
тем, что серверу лучше стоять в общаге, задержки, мол, меньше. Баги же править
не хотел.</p>
<p>В обед 21 ноября 2007 года обсуждение багов в сендере снова вылилось в
перепалку #Kpot# и nuclight, своеобразный рецидив старых времён. Архив тогда
не вёлся, и поэтому фрагменты переписки приводятся прямо здесь (орфография
оригинала сохранена):</p>
<blockquote><b>Вадим &ndash;&gt; АВТФ:</b><br>
<br>
uuu&gt;пишешь сообщение, отправляешь, а оно не выводиться<br>
-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-<br>
vadim&gt;только вчера про это писал, что оно тормозит &mdash; минут 5 подождать надо :)<br>
vadim&gt;ну и давайте снова хором попросим авторов сендера, чтоб поправили баги :)<br>
-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-<br>
#Kpot#&gt;Давайте для начала хором попросим товарища администратора сети
обеспечить хост для сервера на хостеле.<br>
#Kpot#&gt;При нынешней позиции клуба автф.нет не вижу смысла в развитии<br>
-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-<br>
Собсно, когда чуть больше года назад был разговор администрации сети с
авторами сендера, то на том как раз и порешили, что хостинга не будет, пока
не сендер не достигнет приемлемого качества.<br>
Похоже, авторы сендера об этом забыли, ибо не то что каких-то серьезных
улучшений, а вообще никакого развития не было за год. Абсолютно, даже фикса
мелких багов...<br>
<br>
<b>Крот &ndash;&gt; Вадим, приват:</b><br>
<br>
Ваше условие было &mdash; возврат поддержки tcp-сендера<br>
Поддержки не будет, тк пользователям она не нужна.<br>
Хостинг как раз таки необходим для повышения качества, а не наоборот. Пока он
был, качество повышалось, разве не так?<br>
Короче, какова ваша позиция сейчас</blockquote>
<p>На самом деле, как описано в <a href="#seautumn">подразделе за сентябрь
2006</a>, да, было "не так". Качество улучшалось лишь до того, как встал
ребром вопрос о багах, причем не зависело это, был сервер на хостеле или
нет. Такого ультиматума вообще не должно стоять &mdash; что качество программы
улучшается только до тех пор, пока даются какие-то льготные условия. В ряде
случаев такую поддержку еще заработать надо. Но если в случае конкретно с
поддержкой TCPSender разработчиков еще можно понять, то вот со многими
другими багами и предложениями, выдвигавшимися остальными пользователями
сети &mdash; уже нет. Единственным заметным "повышением качества" в сентябре
2006, пока сервер еще был на хостеле, стали "Печатники". Но программа
вступила в ту фазу, когда для повышения качества нужно в большей степени
фиксить баги, чем добавлять новые фичи. А как раз это-то и не делалось
(кроме совсем уж мелких), были только разговоры да так и невыполненные
обещания.</p>
<blockquote><b>Крот &ndash;&gt; Вадим, приват:</b><br>
<br>
vadim&gt;Разговор был длинный, и поддержка была не единственным условием, просто
наиболее актуальным на тот момент &mdash; вспомни ее причины и прочее
обсуждение.<br>
vadim&gt;Оно, скажем, могло бы уже потерять актуальность на данный момент и
пересмотрено, но с вашей стороны к тому подвижек не было абсолютно никаких
(хотя мы совершенно не препятствовали, даже наоборот, например, вы попросили
- мы выделили домен sea, и т.д.).<br>
-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-<br>
не знаю не знаю. Точто помню , Ям сказал: вернете поддержку, сразу будет вам хостинг<br>
Так всё-таки какова ваша позиция сейчас<br>
<br>
<b>Крот &ndash;&gt; АВТФ:</b><br>
<br>
vadim&gt;Собсно, когда чуть больше года назад был разговор администрации сети
с авторами сендера, то на том как раз и порешили, что хостинга не будет, пока
не сендер не достигнет приемлемого качества.<br>
vadim&gt;Похоже, авторы сендера об этом забыли, ибо не то что каких-то
серьезных улучшений, а вообще никакого развития не было за год. Абсолютно,
даже фикса мелких багов...<br>
-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-<br>
Пи#@ёжь и провокация! совсем другое вы год назад говорили<br>
<br>
<b>Вадим &ndash;&gt; АВТФ:</b><br>
<br>
#Kpot#&gt;не знаю не знаю. Точто помню , Ям сказал: вернете поддержку, сразу
будет вам хостинг<br>
#Kpot#&gt;Так всё-таки какова ваша позиция сейчас<br>
-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-<br>
Я уже озвучил выше &mdash; требование поддержки старого сендера было наиболее
актуально именно на тот момент, а сам разговор был длинный, про безопасность
и много чего еще.<br>
Порешили на том, что состояние SEA сендера пока недостаточно для его принятия
официально, и пока что пусть сосуществуют оба клиента независимо друг от
друга, чтоб пользовтаели могли выбирать (однако даже убивание старого сендера
новым клиентом вы пофиксили не сразу).<br>
В общем, позицию можно поменять, но пока SEA остается в состоянии как есть,
без развития &mdash; с нашей стороны точно подвижек не будет.<br>
<br>
<b>Вадим &ndash;&gt; АВТФ:</b><br>
<br>
#Kpot#&gt;Пи#@ёжь и провокация! совсем другое вы год назад говорили<br>
-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-<br>
в привате значит одно говоришь, на группу другое? мало того, что память
короткая, так еще и грязью поливаем?..<br>
<br>
<b>Крот &ndash;&gt; Вадим, приват:</b><br>
<br>
Насчёт того разговора, вы сказали, что когда посчитаете качество сендера
приемлимым, то можно будет объявить его официальной программой общения сети
автф нет. Это да, но причём тут хостинг. Хостел &mdash; ресурс политеха,
предназначенный для студентов общаги, сендером пользуются студенты общаги, в
чём дело? <br>
<br>
<b>Вадим &ndash;&gt; АВТФ:</b><br>
<br>
#Kpot#&gt;Насчёт того разговора, вы сказали, что когда посчитаете качество
сендера приемлимым, то можно будет объявить его официальной программой
общения сети автф нет. Это да, но причём тут хостинг. Хостел &mdash; ресурс
политеха, предназначенный для студентов общаги, сендером пользуются студенты
общаги, в чём дело? <br>
-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-<br>
Хостел выдавался на условиях поддержки совместимости, вы от нее отказались &mdash;
потому и был актуален тот аргумент, что как вернете поддержку, так будет и
хостел. Либо достаточно повысится качество, что можно будет заменить на
официальный и выдать просто по этому факту. С нашей стороны всё логично.<br>
<br>
<b>Вадим &ndash;&gt; АВТФ, отвечая на приватное от Крота:</b><br>
<br>
#Kpot#&gt;Вобщем я иду в деканат и поднимаю тему: администрация сети
отказывается предоставлять ресурсы для сервиса, которым пользуются десятки
студентов общежития. О причинах будете декану объяснять. В письменном
виде<br>
-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-<br>
Год назад перед тем разговором мы справлялись в деканате. С нашими
аргументами о недостаточной безопасности и плохом качестве согласились, как и
с тем, что разрабатывать и/или поддерживать должен кто-то из общаги. Можешь
попробовать, конечно, но сомневаюсь, что у тебя получится.</blockquote>
<p>Аргумент по безопасности действительно был (см. про возможность взлома в
<a href="#seabugs">следующем разделе</a>), и администратор YaM_DJ в этом
отношении был непреклонен (актив сети к тому времени SEA-сендером время от
времени уже пользовался, но запускал его под другим пользователем Windows, с
пониженными правами). Впрочем, Крот так и не пошел в деканат, на этом разговоре
всё и закончилось. Однако позже, в середине декабря 2007, nuclight по своей
личной инициативе (пользователи всё-таки страдали почем зря) пошел на
компромиссный вариант: поднял Java-сервер на своем компьютере в общаге.</p>
<p>Так он просуществовал более года, пережив "революцию" в сети весной 2008 и
смену актива.</p>
<p>В сентябре 2008 новым активом SEA Sender был принят как официальное средство
общения пользователей сети, взамен TCPSender. Однако обязать пользователей его
ставить актив не мог, потому что программа мало того что не развивалась и
глючила, так еще и не все возможности были доступны. Вадим Гончаров, хоть и
закончил, всё еще был техконсультантом актива сети. Он связался с Кротом, и тот
возобновил работу архива, переделав старый на работу с MySQL вместо файлов, и
модифицировав сервер. На этот архив можно посмотреть и сейчас по адресу
<a href="http://sea.tomsk.ru/sender/">http://sea.tomsk.ru/sender/</a> &mdash; он
выглядит почти так же, как и в 2006 году. #Kpot# пообещал заняться сендером и
улучшить что-нибудь еще, но это опять-таки кончилось ничем.</p>
<p>Тем временем пользователей в сендере становилось всё меньше и меньше...</p>
<p class="small" style="text-align: right;"><a href="#toc">назад к оглавлению</a></p>
<a name="seabugs"><h3>Галерея скриншотов багов SEA Sender:</h3></a>
<p>Здесь собраны скриншоты багов оригинального ("штатного") клиента SEA Sender.
В основном их собирал Семён Тян (Peek), по большей части уже после своего
отключения, но внесли свою лепту и другие пользователи.</p>
<table border="1" cellspacing="3" cellpadding="9">
<tr valign="top">
<td frame="border" border="1">
<a name="img-seabug01"></a><a target="_blank"
href="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug01.png"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug01.png"
width="147" height="108" align="center" alt="" title=""></a>
<p class="small">Периодически вот такое он выкидывал, если сервер был не в
той же сети</p>
</td>
<td frame="border" border="1">
<a name="img-seabug02"></a><a target="_blank"
href="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug02.png"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug02.png"
width="150" height="124" align="center" alt="" title=""></a>
<p class="small">Другому человеку в инфе о нас пишет 0.9.2 (см. переписку), а
у нас 0.9.7.4</p>
</td>
<td frame="border" border="1">
<a name="img-seabug03"></a><a target="_blank"
href="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug03.png"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug03.png"
width="132" height="126" align="center" alt="" title=""></a>
<p class="small">Неверный подсчет числа пользователей в списке - симптом более
неприятных багов</p>
</td>
<td frame="border" border="1">
<a name="img-seabug04"></a><a target="_blank"
href="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug04.png"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug04.png"
width="132" height="126" align="center" alt="" title=""></a>
<p class="small">При неверном подсчете получился пустой пользователь TCPSender</p>
</td>
<td frame="border" border="1">
<a name="img-seabug05"></a><a target="_blank"
href="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug05.png"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug05.png"
width="132" height="138" align="center" alt="" title=""></a>
<p class="small">Повреждения затронули не только пустых пользователей TCPSender
сверху, но и одного юзера SEA сделали выглядящим как юзер TCPSender</p>
</td>
</tr>
<tr valign="top">
<td frame="border" border="1">
<a name="img-seabug06"></a><a target="_blank"
href="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug06.png"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug06.png"
width="152" height="154" align="center" alt="" title=""></a>
<p class="small">Вместо имен пользователей стали попадаться обрывки сообщений
под видом пользователей TCPSender</p>
</td>
<td frame="border" border="1">
<a name="img-seabug07"></a><a target="_blank"
href="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug07.png"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug07.png"
width="147" height="108" align="center" alt="" title=""></a>
<p class="small">Окно информации о пользователе представляло собой web-страницу,
которая всё никак не могла прогрузиться - а всё было видно</p>
</td>
<td frame="border" border="1">
<a name="img-seabug08"></a><a target="_blank"
href="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug08.png"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug08.png"
width="147" height="108" align="center" alt="" title=""></a>
<p class="small">Такое время от времени вылетало при коннекте к серверу</p>
</td>
<td frame="border" border="1">
<a name="img-seabug09"></a><a target="_blank"
href="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug09.png"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug09.png"
width="131" height="124" align="center" alt="" title=""></a>
<p class="small">Пустые юзеры TCPSender атакуют, тысячи их!</p>
</td>
<td frame="border" border="1">
<a name="img-seabug10"></a><a target="_blank"
href="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug10.png"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug10.png"
width="147" height="108" align="center" alt="" title=""></a>
<p class="small">И снова вылет ошибки работы с сокетами - заметьте, это третий
раз, и все 3 - разные ошибки</p>
</td>
</tr>
<tr valign="top">
<td frame="border" border="1">
<a name="img-seabug11"></a><a target="_blank"
href="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug11.png"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug11.png"
width="147" height="108" align="center" alt="" title=""></a>
<p class="small">Явная ошибка в имени пользователи - и инфу показывает тоже о
ком-то другом</p>
</td>
<td frame="border" border="1">
<a name="img-seabug12"></a><a target="_blank"
href="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug12.png"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug12.png"
width="133" height="54" align="center" alt="" title=""></a>
<p class="small">Если в предыдущих таких багах можно было нажать "пропустить",
и с высокой вероятностью работа продолжалась - тут ничего сделать уже нельзя</p>
</td>
<td frame="border" border="1">
<a name="img-seabug13"></a><a target="_blank"
href="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug13.png"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug13.png"
width="147" height="107" align="center" alt="" title=""></a>
<p class="small">В чат позвонил человек-невидимка. Или дзен-буддист</p>
</td>
<td frame="border" border="1">
<a name="img-seabug14"></a><a target="_blank"
href="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug14.png"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug14.png"
width="147" height="85" align="center" alt="" title=""></a>
<p class="small">Снова "сиреневые человечки", но на этот раз в строке состояния
пусто</p>
</td>
<td frame="border" border="1">
<a name="img-seabug-080424"></a><a target="_blank"
href="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seasender-bug-080424.gif"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/seasender-bug-080424.gif"
width="142" height="98" align="center" alt="" title=""></a>
<p class="small">Иногда окно ввода сообщения вдруг переключалось вот в такой
режим, где всё справа налево. Наверное, это секретный сендер для арабских
террористов</p>
</td></tr></table>
<p>В скриншоты, правда, не попал еще один баг, обнаруженный еще Мишаней в
ноябре 2006. Тогда ему не придали большого значения и не зафиксировали, хотя
позже оказалось, что он серьезнее вышеперечисленных. Мишаня тогда игрался с
чатом, и при определенных условиях добивался весьма неожиданных эффектов.
Больше внимания он обращал на сервер (тот мог начать тормозить с передачей
сообщений, например), а стоило именно на клиент.</p>
<p>Заключался он в том, что при определенном вводе в чат в общем окне строк
чата могло вывалиться совершенно не то, что ввёл пользователь, а куча букв M на
много экранов. Как было выяснено много позже, это &mdash; симптом переполнения
буфера. В программах на Си такое встречается при ошибках работы с памятью. Вот
только этот баг отнюдь не безобиден &mdash; переполнение буфера любят использовать
хакеры для удаленного исполнения кода. То есть, это &mdash; самая настоящая
уязвимость, которую можно использовать для взлома машин пользователей и
получения над ними полного контроля &mdash; учитывая, сендер часто любят запускать с
админскими правами... Общагу спасло только то, что настолько серьезных хакеров
у нас не было (хотя в Томске были), никто не заинтересовался. Впрочем, если
вспомнить случай с Muzzy, кто знает, в самом деле ли?..</p>
<p>Точного способа воспроизведения бага не осталось, кроме неполного описания
&laquo;Пользователь В посылает в уже открытое окно большую строку (по идее не
превышающую 127)&raquo;. По всей видимости, баг связан с тем, что клиент
трактует числа, приходящие из сети, как знаковые, а не беззнаковые.</p>
<p>Остается только напомнить, что админское чутье не подвело актив сети в том
разговоре в начале октября 2006. Увы, тогда такой информации не было, и актив
в результате поступил весьма либерально, разрешая пользоваться сендером тем,
кто этого хочет: в отношении заплаток к винде (не всех, а тех, что черви
использовали для распространения по сети) политика была более жесткая &mdash;
отключение от сети до исправления проблемы.</p>
<p class="small" style="text-align: right;"><a href="#toc">назад к оглавлению</a></p>
<a name="blastcore"><h2>Настоящее время</h2></a>
<p>В мае 2009 пользователей в сендере оставалось всего лишь около 30 человек.</p>
<p>Совсем мало, особенно если учесть, что сеть с тех пор выросла в 2 раза, а
в сендере тогда сидело под сотню человек. Актив сети такое положение не
устраивало &mdash; сендер был удобен, например, для вывешивания объявлений активом,
но получалось, что мало кто мог их прочитать.</p>
<table align="right" style="margin: 9px;" border="0"><tr valign="top"><td width="268" height="116">
<a name="img-blast-trayinfo"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/blast-trayinfo.png"
width="268" height="116" align="center" alt="" alt="BlastCore - двойной щелчок
по иконке в трее"></a></td></tr>
<tr><td><p class="small">Двойной щелчок по иконке BlastCore в трее</p>
</td></tr></table>
<p>Новый администратор сети Михаил Шеховцов (Knauer) обсудил этот вопрос с Вадимом
Гончаровым (nuclight), техническим консультантом сети, когда последний
поинтересовался возможностью забрать свою машину из общаги через несколько
месяцев (на тот момент она использовалась почти только для хостинга сервера).
Решили, что сервер надо переписать на Си, чтобы он мог работать на хостеле (с
того к тому времени давно уже снесли Java), и чтоб не глючил. 22 мая nuclight
занялся этим в свободное время, а когда сервер был готов к началу тестирования,
12 августа 2009 ему пришла в голову мысль, что можно ведь привлечь и Семёна,
доделать когда-то созданный им BlastCore, на замену старому штатному клиенту.</p>
<p>И вот, по старому знакомству, они незамедлительно развернули работу, возродив
канал #SEASender в IRC-сети RusNet.</p>
<p>Разработка была организована на современном уровне. Был зарегистрирован
проект на <a href="http://code.google.com/p/blastcore/">http://code.google.com/p/blastcore/</a>,
с использованием системы контроля версий SVN (каждое изменение в коде фиксируется
системой, можно отслеживать, что именно привело к тому или иному багу, откатывать
его, и т.д.). Исходники, в отличие от всех предыдущих сендеров, публично
доступны, любой желающий может получить с сайта версию BlastCore на любой
момент в прошлом (под Windows это можно сделать с помощью
<a href="http://tortoisesvn.net/">TortoiseSVN</a>).</p>
<p>Администрация сети, однако, заинтересована в том, чтобы не остаться без
разработчиков и использовать все возможности &mdash; конкуренция будет на благо
пользователям. Поэтому актив сети связался и с Алексеем Фадеевым (#Kpot#), но
тот ответил, что один продолжать разрабатывать SEA Sender не будет, и отдал
исходные тексты клиента и сервера &mdash; дабы желающие могли продолжить. Впрочем, он
сказал, что у него есть кое-какие идеи о том, как можно было бы сделать сендер
лучше, написав заново, что вполне потянет для кого-нибудь на дипломную работу &mdash;
но оформит эти идеи в письменном виде он попозже.</p>
<p>Что ж, тоже результат &mdash; эти исходники помогли уточнить некоторые туманные
моменты в реализации, неочевидные из перехвата протокола.</p>
<p>И вот, 13 сентября 2009 года, в День Программиста, публично был анонсирован
BlastCore 0.2 beta, умевший полный набор фич штатного клиента SEA Sender (за
исключением <a href="#img-tcps-chat">кнопки "звонка"</a> для той стороны во
время установленного чата), и ряд интересных решений сверх того.</p>
<p>Например, добавилось обрезание цитат: раньше при активной переписке (ведь
добавляются слова после цитаты) весь текст переставал влезать в окно, нужно
было проматывать. Теперь сендер автоматически обрезал самые старые цитаты,
заменяя их на многоточие (пользователю это было делать лениво).</p>
<p>Через 10 дней вышла версия 0.21 beta, которая содержала только исправления
ошибок и незначительные косметические правки. Вот так она выглядела:</p>
<a name="img-blast-main"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/blast-main.png"
width="660" height="572" align="center" alt="" title=""></a>
<p>Здесь первое, что бросается в глаза: выпадающий список сообщений был заменен
на панель внизу окна, где сообщения стало можно выделять галочками (помечаются
и сами при прочтении сообщения) для дальнейшего удаления только выделенных
новой кнопкой удаления. При желании панель можно скрыть совсем, щелкнув по
разделителю &mdash; информация пишется и на привычном месте вверху (но теперь её
стало можно выделить и скопировать). Панель, кроме того, показывает длину
сообщения и некоторую техническую информацию &mdash; ID отправителя, флаг того, что
адресовано печатникам.</p>
<p>Из менее заметных изменений можно отметить подсветку ссылок в тексте (и
если щелкнуть, то откроется в браузере), иконка над сообщением снова, как и в
TCPSender, показывает, приватное оно или групповое, добавлены кнопки на
панели инструментов для быстрой "перемотки" в начало и конец списка, а также
удаления всех сообщений.</p>
<p>Полезные изменения коснулись и системного трея: теперь контекстное меню там
содержит некоторые частоиспользуемые функции &mdash; например, отключить звуки на
ночь (или встать в away) можно без раскрытия окна и залезания в опции. Еще
BlastCore стал уметь показывать и сами сообщения в трее без разворачивания
окна, как современные клиенты ICQ:</p>
<table border="0" cellspacing="5" cellpadding="10"><tr valign="top">
<td>
<a name="img-blast-traymenu"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/blast-traymenu.png"
width="326" height="181" align="center" alt="" title=""></a>
<p class="small">Предыдущие сендеры имели только один пункт: "Выход"</p>
</td><td>
<a name="img-blast-traymsg"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/blast-traymsg.png"
width="423" height="153" align="center" alt="" title=""></a>
<p class="small">Показ сообщения в "Balloon Hint" сразу, как только оно пришло.
<br>Предыдущие сендеры умели только развернуть окно целиком, что гораздо менее
удобно</p>
</td></tr></table>
<p>После выхода 0.21 beta разработка несколько замедлилась, потому что набор
возможностей уже был больше чем у штатного клиента, а надо было переключиться
на другие насущные задачи. Так, нужен был нормально работающий архив. Peek
поднял свои архивы, как утянутые во время взлома, так и те, что велись его
собственной программой в 2007. Екатерина Блеч (Ketra) написала новую версию
Web-архива, сначала с той же функциональностью, что и в оригинале, а к декабрю
доработала её до более удобных возможностей: появилась возможность поиска по
архиву и показ произвольного числа сообщений между любыми двумя датами, в любом
порядке сортировки.</p>
<p>Пользователи после тестирования были переведены на новый сервер, который
написал nuclight и который был модифицирован для более гибкой отдачи сообщений
в архив. Теперь все старые глюки исчезли, а все архивы были импортированы в
новый, располагающийся на сервере общежития. В BlastCore тем временем появились
некоторые новые мелкие фичи, а также поддержка скинов и настроек шрифтов текста
сообщений. Авторами была задумана возможность отправлять форматированный текст,
а также со временем сделать и давно просимую пользователями возможность
передачи файлов &mdash; правда, протокол SEA Sender позволяет реализовать её только
в ограниченном виде. Но об этом в <a href="#seashit">следующем разделе</a>.</p>
<p>К сожалению, в 2010 году дела у BlastCore Sender пошли гораздо хуже. Семён
Тян почти совсем забросил разработку, и версия 0.4, ожидавшаяся изначально в
январе, была отложена сначала до апреля, а потом и до нового учебного года.
Виной тому послужил в основном испортившийся характер самого Peek &mdash; хотя он
дал обещание выпустить версию 0.4 к сентябрю, срок затянулся сначала до
середины месяца. А потом Семён и вовсе подвел народ (готовность должна была
быть к началу подключения новых пользователей), бросил всё и ушел, когда
оставалось совсем чуть-чуть. Евгению Родионову (rodya), автору инсталляторов
всех версий BlastCore, пришлось вносить последние правки в условиях жесткой
нехватки времени &mdash; был конец сентября, навалилась и учеба, и подключение новых
пользователей.</p>
<p>Сейчас версия 0.4 поддерживает прием форматированного текста (полужирный,
цветной и т.д.), поддерживает смайлики, умеет проверять наличие обновлений &mdash; но
вот будущее этих обновлений теперь весьма туманно. Впрочем, на этот раз все
исходники открыты, и разработку может продолжить любой желающий.</p>
<p class="small" style="text-align: right;"><a href="#toc">назад к оглавлению</a></p>
<a name="seashit"><h2>Недостатки SEA Sender с точки зрения программиста</h2></a>
<p>Этот раздел предназначен для тех, кто хочет разобраться в вещах, сходу
неочевидных и пользователю невидимых, но, тем не менее, влияющих на то, что
пользователь может или не может получить от программы. Речь идет об
<i>архитектуре</i> проекта, в сетевых системах наиболее важной частью которой
является <i>протокол</i> взаимодействия (обычно между клиентом и сервером).
Когда пользователь просит добавить галку в опции или сменить звук, это автор
может сделать легко. Но когда пользователь просит сделать передачу файлов, или,
скажем, уведомление, что та сторона в чате "Сейчас печатает" &mdash; автор неожиданно
сталкивается с тем, что это очень трудно, если вообще возможно. Потому что было
<i>не предусмотрено</i> в протоколе. Для этого оказывается нужным переделать
чуть ли не всю систему. Ну, как в свое время TCPSender не мог работать за
NAT, например &mdash; пришлось менять архитектуру на клиент-серверную, а с ней и
протокол.</p>
<p>Вот именно об ошибках <i>проектирования</i> SEA Sender и пойдет главным
образом здесь речь, хотя будут затронуты и вопросы реализации сервера.</p>
<p>Почему более важен протокол, а не реализация? Потому что именно он
определяет реализацию, а не наоборот.</p>
<p>Помните, как сказал классик?</p>
<blockquote>&laquo;Покажите мне свой код и спрячьте структуры данных &mdash; и я останусь
одураченным. Покажите мне свои структуры данных, и мне, скорее всего, не
понадобится ваш код, он будет очевидным.&raquo;<br>(Ф. Брукс, &laquo;Мифический
человеко-месяц&raquo;, гл.9)</blockquote>
<p>Но это было сказано для программы, в случае же с протоколами всё еще хуже:
протокол нельзя поменять так просто, как программный код, потому что придется
менять <i>все</i> реализации в сети сразу &mdash; что очень сложно даже при наличии
контроля над ними, не говоря уже о реальном мире, где приходится поддерживать
совместимость со старыми версиями.</p>
<p>На самом деле, проблема этой распространенной ошибки в том, что люди
<a href="http://www.joelonsoftware.com/articles/fog0000000036.html">думают,
будто бы на проектирование не стоит тратить время &mdash; но ошибочность этой
позиции выявляется гораздо позже, когда приходится менять в коде гораздо
больше, а итоговое качество его при этом всё равно страдает</a>. В конце
концов, среди провалившихся проектов гораздо больше тех, которые не уделили
должное внимание проектированию, архитектуре и написанию спецификаций, чем
среди тех, в которых таки уделили.</p>
<p>Но вернемся к SEA Sender. Для понимания дальнейшего текста нужно будет
держать перед глазами две графические иллюстрации протокола: это команды
<a href="http://seasrvkq.googlecode.com/files/seaproto_c2s.png">от клиента серверу</a> и
<a href="http://seasrvkq.googlecode.com/files/seaproto_s2c.png">от сервера клиенту</a>. Их
подготовил Семён Тян (Peek) во время работы по перехвату данных между клиентом
и сервером SEA Sender, тем же методом реверс-инжиниринга, что писались и
альтернативные клиенты ICQ.</p>
<p>На картинке не подписано, но все числа длиннее одного байта передаются в
так называемом сетевом порядке байт &mdash; от старшего к младшему. Это верное
решение: в архитектуре x86 числа хранятся в обратном порядке (<a
href="http://ru.wikipedia.org/wiki/Little-endian">little-endian</a>), и для
обработки машиной их нужно конвертировать. Неопытные программисты часто пишут
числа в сеть как есть, в результате система неожиданно откажется работать на
ряде других аппаратных платформ (Macintosh/PowerPC, мобильные устройства, ряд
других). Здесь эта ошибка не допущена.</p>
<p>Но вот дальше начинаются, как говорят зарубежные коллеги, idiosyncrasies.</p>
<p><b>Три байта.</b> Для конвертации 16-битных (<b>s</b>hort) и 32-битных
(<b>l</b>ong) значений существуют стандартные функции <tt>htons()</tt>,
<tt>htonl()</tt> для <b>h</b>ost to <b>n</b>etwork, и <tt>ntohs()</tt>,
<tt>ntohl()</tt> для <b>n</b>etwork to <b>h</b>ost. В протоколе же SEA Sender
для длины пакета используется нестандартное, 3-байтное значение. В результате
в реализации необходимо писать свои собственные функции. Более того, столько
и не нужно &mdash; во всех остальных местах протокола используются 16-битные
значения, и длина команды в худшем случае превысит 65535 лишь на 7 байт (но
заголовок можно и не считать).</p>
<p>Еще смешнее становится, если заглянуть в исходники сервера и клиента
SEA Sender: функция <tt>lenintto3bytes()</tt> (и аналог в обратную сторону)
повсеместно используется <i>вместо</i> <tt>htons()</tt>, с дополнительным
кодом по игнорированию старшего третьего байта &mdash; похоже, авторы просто не знали
о существовании стандартных функций.</p>
<p><b>Расширяемость: длина команды от сервера.</b> Можно видеть, что клиент
сначала пишет полную длину команды, потом идет она сама. Таким образом, сервер
читает её целиком, потом может обрабатывать. А вот в обратном направлении, от
сервера к клиенту &mdash; никакой общей длины команды не пишется. В итоге становится
невозможно ввести в протокол новые команды, не обучив им клиент: он читает один
байт команды и по нему определяет, когда начнется следующая. В случае, когда
номер команды неизвестен, то клиент не знает, какой она длины, и где начнется
следующая.</p>
<p>Если бы сервер писал полную длину команды перед ней, то клиент мог бы
просто игнорировать неизвестные ему команды. Очевидно, что подход "не писать
клиенту длину" немного проще для сервера в реализации &mdash; её не нужно заранее
высчитывать. Зато это оборачивается гораздо бОльшим количеством кода потом,
когда для каждой новой команды серверу приходится проверять версию клиента &mdash;
поймет ли он её.</p>
<p>Кроме того, полезным было бы добавление <i>сигнатуры</i> в команды &mdash;
несколько байт, которые должны равняться строго определенному значению ("magic
number"). Клиент и сервер могли бы проверять их в начале каждой команда, тогда
ошибки рассинхронизации (типа <a href="#img-seabug06">вот этой</a>) были бы
сразу обнаружены.</p>
<p><b>Неконсистентность представления IP-адреса.</b> В командах #1 и #6 от
сервера идет байт длины, затем IP-адрес в <i>текстовом</i> виде. Тогда как
его всегда можно представить как 4 байта, что и сделано в команде #13. К тому
же, чтение адреса из сети в текстовом виде (обработка байта длины) &mdash; это
дополнительный код, без которого можно было бы обойтись.</p>
<p><b>Неоптимальный формат команд.</b> Этот пункт обусловлен двумя
предыдущими &mdash; отсутствием поля общей длины. В результате в командах нужны свои
собственные поля длин, причем в случае передачи от клиента серверу &mdash; они
фактически бессмысленно дублируются. А нередко и просто излишне ограничивают.
Например, команды чата #7 или получения URL архива #9 &mdash; ограничены 256 байт (а
на самом деле 127 из-за багов клиента).</p>
<p>Кроме того, расположение полей часто заставляет писать дополнительный код
по обработке. Например, для чтения ответа на запрос информации о пользователе
(#6) клиенту нужно:</p>
<ul>
 <li>прочитать байт #6</li>
 <li>прочитать 7 байта: факультет, комната, байт длины Info</li>
 <li>прочитать n байт Info</li>
 <li>прочитать байт версии и байт длины IP-адреса</li>
 <li>прочитать n байт IP-адреса</li>
</ul>
<p>Если IP-адрес представить в двоичном виде, сократится только один шаг. Но
если бы было общее поле длины, а байты версии и адреса поставить <i>до</i>
кусков переменной длины, а не после, осталось бы всего 2 шага:</p>
<ul>
 <li>прочитать байт #6 и общее поле длины</li>
 <li>прочитать n байт тела команды, выделить фиксированные части, остаток же до
 конца команды &mdash; будет полем Info</li>
</ul>
<p><b>TCPSender: диапазон ID.</b> При входе клиента (команда #1 от сервера)
клиент получает списки пользователей SEA Sender и TCPSender раздельно. Это
нормально. А вот в команде #2 никак не указано, кто вошел в сеть. В какой из
двух списков его добавить? В результате в реализации был искусственно выбран
диапазон ID 1000-2000 для пользователей TCPSender &mdash; клиент различает их по
номеру. Это означает, что более 1000 клиентов SEA держать не получится. Число
может показаться достаточно большим, но на самом деле оно зависит от способа
выдачи нового ID на сервере. Счетчик может быть гораздо больше реального числа
пользователей (из соображений уникальности, например) &mdash; и это действительно
происходило. Ряд <a href="#img-seabug04">багов</a> <a href="#img-seabug09">с
"сиреневыми</a> <a href="#img-seabug14">человечками"</a> был вызван в том
числе и этим.</p>
<p><b>TCPSender: сообщения, шлюзование.</b> Поддержка TCPSender реализована
плохо, без учета последствий. Даже после отключения &mdash; она всё равно намертво
зашита в протоколе. Например, при получении сообщения, после полного его
чтения, снова идёт один байт длины, потом имя пользователя, снова байт длины,
имя машины. Но только, если ID отправителя был нулевым. Растет это, видимо, из
каких-то проблем при поддержке TCPSender &mdash; послать такое мог только сервер. А
обрабатывать дополнительный ноль приходится и по сей день.</p>
<p>Вообще, поддержка старого сендера должна была быть сделана совершенно иначе.
Нужно было написать <i>шлюз</i> &mdash; специальный модуль, понимающий оба протокола
и осуществляющий конвертацию между ними. А клиент и сервер умели бы сугубо
свой, чистый протокол. Так поступают, например, в мире Jabber. И после
отключения поддержки TCPSender не пришлось бы тащить за собой заглушки в коде.
Которые и по сей день негативно влияют на возможность расширения протокола...</p>
<p><b>Печатники.</b> Удивительное дело, но сообщение группе "Печатники"
считается приватным &mdash; у него стоит соответствующий флаг. Можно предположить,
почему, но всё равно остаться в недоумении: допустим, это не поняли бы старые
клиенты (что не умели печатников). Но ведь старый клиент и не сможет войти в
группу печатников и получать такие сообщения!</p>
<p>Это еще не всё. Вроде бы, вполне достаточно ID получателя 65535, чтобы
понять: ага, это для печатников сообщение. Но нет, предусмотрительно
зарезервированное поле, целых два байта в заголовке сообщения, отводятся под
специальный флаг! Именно два: сервер выставляет <b>каждый</b> из них. Хотя
клиент проверяет только один из них (хуже того, BlastCore проверяет другой из
них, чем штатный клиент). Такая проверка резко снижает дальнейшую возможность
расширения протокола.</p>
<p><b>Расширяемость: Away.</b> Казалось бы, как можно намудрить с такой
простой командой, как войти/выйти из away? Но и здесь есть свои недоделки.
Away был введён довольно поздно. Старые клиенты не понимали бы такую команду.
Поэтому сервер после получения информации о пользователе, убедившись, что
клиент поддерживает, шлет ему ряд команд away &mdash; как будто бы эти пользователи
встали в away только что. Правильным решением было бы иметь расширяемый
формат списка пользователей (а заодно и информации об одном пользователе), где
и выставлять этот флаг.</p>
<p><b>Чат.</b> Что здесь может плохого? Ну, про ограничение длины уже выше
говорилось. Однако реализован чат и в других местах <s>через жо</s> своеобразно.
Клиент не хранит состояние &mdash; оно определяется открытыми сейчас формами. В
результате используется <b>четыре</b> команды-запроса #7 для установления вместо
двух, и три #8 вместо одной. Сначала инициатор (И) посылает #7, у получателя
(П) высвечивается окно "Хотите ответить? Да/Нет". Если да, то П отвечает
пустым #7 как подтверждением, И создает окно чата и <b>еще раз</b> шлет #7. В ответ
на получение такого #7 П создает своё окно чата и тоже шлёт пустой #7. Всё,
чат установлен, теперь #7 идет непустой, с текстом.</p>
<p>Если текст специальный, "<tt>//beep//</tt>" &mdash; то на той стороне прозвенит
звонок. Этот подход был бездумно скопирован из протокола TCPSender, хотя лучше
было б использовать какое специальное значение, которое невозможно набрать с
клавиатуры. А заодно и возможность "сейчас печатает" приделать, как в аське,
раз уж спецкоманда.</p>
<p>Закрывается чат пустыми #8: на команду юзера просто посылается #8, а на
прием #8 &mdash; закрывается окно у нас и отсылается #8. То есть, сначала тот, кто
хочет закрыть, шлет #8, ему приходит ответный #8, который закроет ему окно;
при закрытии своего окна он отправит #8, который та сторона уже
проигнорирует.</p>
<p>Заморочено, да? А для версий до 0.9.4 было еще хуже.</p>
<p><b>Версии и строки.</b> Вообще, в версиях до 0.9.6 даже такая команда mute
обрабатывалась по-другому. Представление самих версий тоже оставляет желать
лучшего. И для 0.9.7, и для 0.9.7.4 получается одна и та же &mdash; 97. Фактически,
это версия протокола, которая нужна серверу. А человеку можно было бы показывать
и строкой &mdash; заодно позволив и другие варианты, не только SEA Sender.</p>
<p>Впрочем, константные строки применялись и в других местах. Например, в код
клиента жестко вшиты названия "АВТФ" и "МСФ" для номеров факультетов 1 и 2 в
юзеринфе, соответственно. Это сразу ограничивает применение сендера только
конкретными общежитиями (TCPSender мог использовать кто угодно). Но даже и тут:
вот сейчас идет реорганизация ТПУ и переименование факультетов в институты. И
всё, старая схема больше не годится...</p>
<p class="small" style="text-align: right;"><a href="#toc">назад к оглавлению</a></p>
<a name="javashit"><h3>Проблемы реализации</h3></a>
<p>Всё вышеперечисленное относилось к проблемам протокола/архитектуры &mdash; то есть
к таким вещам, которые не могут быть исправлены простым переписыванием кода.
Ниже речь пойдет о тех проблемах, которые такому исправлению поддаются, и в
<a href="#blastcore">переписанном в 2009 году</a> сервере действительно были
поправлены.</p>
<div class="breakoutr"><b>Декомпилированный сервер, ноябрь 2006</b>
<pre><b>Строк     Байт Файл</b>
   66     1493 DisconnectSender.java
   66     2009 Listener.java
   49     1273 PhpListener.java
   48     1159 ScanAnswerer.java
  116     3170 ScanAnswerer2.java
   50     1187 Scaner.java
   75     1893 Scaner2.java
  242     6298 ServSender.java
  166     4445 TCPSender.java
   95     2711 TSAdder.java
   39      946 TSMsgAnswerer.java
  131     3509 TSMsgAnswerer2.java
   62     1431 TSUser.java
  236     6736 Tools.java
   84     1984 User.java
  656    25673 Worker.java
 2181    65917 Всего</pre></div>
<p>Оригинальный сервер состоял из 16 классов на Java, хотя в отданных в 2009
году исходниках присутствует только 11 файлов <tt>.java</tt> (однако есть все
16 бинарных <tt>.class</tt>). Поскольку исходники были получены не сразу, а
пограничные случаи типа изменения формата команды в зависимости от версии
клиента по одному лишь перехвату данных не сделать, то в августе 2009 года был
разыскан декомпилятор Java-кода, и использована та версия, что Peek утащил при
взломе.</p>
<p>Сам же новый сервер был написан на чистом Си, одним файлом, 2600 строк, 86
Кб. С промежуточной версией на начало сентября 2009 можно ознакомиться <a
href="/~vadim/sender/seasrvkq.c.html">здесь</a> (впоследствии сервер, как и
BlastCore, стал располагаться на <a
href="http://code.google.com/hosting/search?q=label:SEA-protocol">Google
Code</a>).</p>
<p>Начат он был вечером 22 мая 2009, писался в свободное время, которое
тщательно замерялось, и заняло 46 часов 12 минут на написание до первого
запуска, затем еще 29:20 было потрачен на отладку, до введения его в строй
основным сервером.</p>
<p>Код обильно снабжен комментариями (в отличие от оригинального сервера), в
блоках с пометкой <tt>SEA SHIT</tt> подробно описаны те проблемы SEA Sender,
которые надо было решать. Часть из них уже была описана выше &mdash; это проблемы
протокола. Остальное же &mdash; ошибки оригинального Java-сервера</p>
<p>И проблемы начинаются сразу же, с процедуры <b>логина пользователя.</b> В сервере
не была предусмотрена корректная процедура сообщения пользователю, что он себе
в настройках ввёл некорректный ник. Ну, например, что там символы HTML
<tt>&lt;</tt> и <tt>&gt;</tt> (помните порнуху в архиве?). Зато сервер молча
убивал пользователя, если ник начинался с пробела. Это явно было сделано
сугубо против <a href="#seavtfnet">выходок Мишани</a>, но пришлось сохранить
и в новом сервере &mdash; потому что иначе сбивалась сортировка в штатном клиенте.
А раз нельзя пользователю отказать во входе, придется заменять символы в нике.
Поэтому выделена функция <tt>escape_name()</tt> (при правильной архитектуре
вообще была бы не нужна), которая заодно проверяет на дополнительные ошибки,
типа символов перевода строки или вообще чего-нибудь управляющего. Она же
применяется при обработке смены ника пользователем на лету &mdash; вот там
оригинальный сервер не делал проверок даже на пробел!</p>
<p>Раз уж речь зашла об эскейпинге имен, которая изначально делалась для
<b>архива</b>, надо сразу сказать и о реализации архива. Изначально Java-сервер
просто открывал файл с именем типа 18_11_2006.php и дописывал туда сообщение.
В 2008 Крот сделал схему более корректной: сервер стал соединяться с MySQL-базой,
что позволило держать архив и сервер на разных машинах &mdash; а заодно и решило бы
проблему отсутствия в архиве сообщений с альтернативного сервера. Однако и это
не лучшее решение. Лучшим было бы, если б протокол поддерживал получение старых
сообщений собственными средствами (как оффлайновые в ICQ), но это решаемо
только <a href="#thsender">совсем другим протоколом</a>.</p>
<p>Здесь же остается только сделать архив модульным: с базой, или что там еще,
общается отдельный процесс, он пусть и занимается эскейпингом и всем прочим.
Сервер же на Си просто пишет в поток сообщения, очень простым микропротоколом.
Решение в лучших традициях Unix: этот поток можно направить вообще не в процесс,
а в файл, позже же просто подать файл на вход процессу-обработчику. Так можно
обеспечить и бОльшую надежность при недоступности архива...</p>
<p>Но вернемся ко <b>входу пользователя на сервер.</b> Первой командой должна
быть строго определенная: #1, с ником и машиной. И сервер ожидал первой именно
её. Но если первой была не она &mdash; сервер ничего не делал, коннект просто
оставался висеть открытым. Так можно и ресурсы сервера исчерпать при желании.
Не проверял он, и если такая команда поступит в середине сессии &mdash; хотя и не
ответит.</p>
<p>Зато в коде предпринимаются специальные меры, чтобы вновь вошедшему
клиенту в списке всех пользователей отдать информацию о нем самом &mdash; самым
первым в этом списке. Этому посвящены от 20 до 50 строк Java-кода, смотря как
считать. Вероятно, это имеет какую-то особую важность для клиента (или просто
обход бага), но на всякий случай было повторено и в Си-сервере. Только уже
двумя строчками (13 на весь кусок), а не портянкой на несколько экранов &mdash;
элегантными макросами <tt>LIST_INSERT_HEAD</tt> и <tt>LIST_FOREACH</tt>.</p>
<p>Вообще, несмотря на богатство инструментария Java, работа со связными
списками в оригинальном сервере осуществлена из рук вон плохо. Вот типичный
кусок обработки списка пользователей, который повторяется во многих местах
(здесь он используется для отправки массива байт <tt>b</tt>):</p>
<blockquote><pre>while(!user.server.sourcelistfree) 
    try
    {
        sleep(50L);
    }
    catch(Exception ex) { }
user.server.sourcelistfree = false;
int cnt = user.server.Usercnt();
int j = 0;
User userlist[] = new User[cnt];
for(User usr = user.server.last; usr != null; usr = usr.prev)
{
    userlist[j] = usr;
    j++;
}

user.server.sourcelistfree = true;
OutputStream os = user.sock.getOutputStream();
for(j = 0; j < cnt; j++)
    if(userlist[j] != user && userlist[j].away && user.vers >= 96)
    {
        b = Tools.lenintto3bytes(userlist[j].id);
        b[0] = 11;
        os.write(b);
    }</pre></blockquote>
<p>Это фееричные 25 строк, шедевр, достойный
<a href="http://govnokod.ru/">govnokod.ru</a>! И хрен бы еще с ним, со связным
списком, а вот мимо ошибок синхронизации пройти нельзя.</p>
<p>Обратите внимание на переменную <tt>sourcelistfree</tt>. Это флаг
использования списка пользователей: если он используется другой нитью (thread),
то наша &mdash; ждёт освобождения. Потом взводит сама (чтоб теперь другие не
использовали), копирует список во временный массив, отпускает общий список и
работает с копией.</p>
<p>Проблема с этим кодом описывается в любом курсе по операционным системам:
это классический race condition. Если другая нить сделает ту же проверку
<tt>while(!user.server.sourcelistfree)</tt> в промежутке между нашей
проверкой и присвоением <tt>user.server.sourcelistfree = false</tt> &mdash; то
доступ получат сразу две нити. Кроме того, нить работает с <i>копией</i>
списка &mdash; и если за это время он изменился (вошел или вышел пользователь),
то результат снова будет неверен.</p>
<p>Ясно, что архитектура сервера "по одному треду на клиента" была выбрана,
потому что так проще работать с сокетами. Но корректное программирование
многопоточных приложений при наличии общих данных &mdash; задача уже отнюдь не
простая. Даже при использовании корректных <tt>атомарных</tt> средств
синхронизации тредов в сложных приложениях бывают разнообразные ошибки
программирования (deadlock'и и т.д.), что уж говорить об их отсутствии.</p>
<p>Именно этой проблемой и были вызваны проявлявшиеся в непредсказуемые
случайные моменты ошибки с отправлением сообщений от имени не того
пользователя и длительные задержки доставки.</p>
<p>Сервер на Си (seasrvkqd) был построен по другой архитектуре: как
конечный автомат (FSM, Finite State Machine). Здесь только один тред, а
управляется всё получением событий на сокетах от операционной системы:
ОС FreeBSD предоставляет здесь очень удобный механизм <tt>kqueue()</tt>.
Блоки комментариев в коде с пометкой <tt>KQ FEATURE</tt> описывают его
возможности.</p>
<p>Такую же самую архитектуру с тем же самым системным вызовом <tt>kqueue()</tt>
использует, например, известный высокопроизводительный Web-сервер nginx,
автор которого демонстрировал 100 000 (сто тысяч!) одновременных соединений.
Наверное, не стоит добавлять, что сервер работает очень стабильно, почти не
потребляя процессорного времени.</p>
<p>Отдельно надо сказать о <b>пингах</b>, раз уж зашла речь о ресурсах. Во
всех клиент-серверных системах с длительным постоянным соединением сервер
периодически отправляет клиенту "пинг", специальную пустую команду, просто для
проверки живости соединения. Зачем это делается? Для того, чтобы клиент не
занимал ресурсы сервера, а в системах типа сендера/IRC/ICQ &mdash; также для того,
чтобы остальные клиенты узнали, что этот уже "отвалился". Причем природа сетей
такова, что TCP-соединение, если по нему не ходят данные, может висеть
неделями. Можно установить коннект, не слать по нему данные и выдернуть кабель
из промежуточного маршрутизатора. Соединение останется активно. Придти через
день, воткнуть, что-нибудь отправить &mdash; оно оживет, данные побегут как ни в чем
не бывало. Но если потеря связи начнется во время передачи (отправить, пока
кабель выдернут), тогда через некоторый таймаут ошибка будет обнаружена, и
соединение разорвется.</p>
<p>Более того, природа ошибок такова, что надо проверять именно приход <u>ответа</u>
на уровне протокола приложения (уровень 7 в OSI) &mdash; просто посылка данных не
гарантирует корректности. Например, запись в сокет могла быть успешной, данные
были доставлены удаленной машине &mdash; и как раз в этот момент зависло приложение
(а машина работает, данные принимает).</p>
<p>А в SEA Sender наоборот, пинги идут от клиента к серверу. В результате при
обрыве связи в лучшем случае клиент заметит и откроет еще один коннект: будет
два одинаковых пользователя в списке. В худшем же &mdash; и больше, и очередной
реконнект упрется в лимит: все висящие на сервере соединения будут "призраками",
причем на неопределенное время &mdash; сервер ничего не проверяет. Видимо, авторы
просто поленились сделать работу с таймерами, а о сетевой стороне, как всегда,
не подумали...</p>
<p>Не подумали они и о <b>проверках на ошибки</b>. То есть совсем. Даже размеры
команд не проверяются &mdash; по протоколу может требоваться 1 байт, а клиент зашлет
всё 16 Мб, и пускай на сервере память жрется, ага... В коде seasrvkqd есть
предназначенный для этого макрос <tt>CHECK_LENGTH</tt>, который при запуске в
режиме строгих проверок убивает клиента: ведь это может быть и симптомом бага
в клиенте, надо сигнализировать и разобраться...</p>
<p>Не проверяет сервер пустые сообщения &mdash; то есть, нулевого размера. Хотя это
явно или баг, или же кто-то пытается ими флудить.</p>
<p>Кроме того, несмотря на целых два прецедента (с Muzzy и Мишаней) в сервере
нет совершенно никакой защиты от флуда. В seasrvkqd был встроен флуд-контроль,
базирующийся на принципе "пенальти" из IRC. За отправку каждой команды клиенту
начисляются "штрафные" секунды, которые прибавляются к его пенальти-счетчику
(если клиент долго молчал, этот счетчик сначала обновляется до текущего
времени). Допустим, по одной секунде за одну строку в чат, по 2 секунды за
сообщение, и т.д. Если счетчик убегает в будущее (больше текущего времени) на
определенный порог &mdash; значит, клиент флудер, начинаем его тормозить
(обрабатываем команды от него раз в 2 секунды). Если он продолжает флудить и
превышает следующий порог &mdash; клиент убивается совсем. Пороги и штрафы подобраны
таким образом, чтобы нормальный пользователь ничего не заметил. Например, для
сообщений штраф равен двоичному логарифму от длины сообщения. То есть, обычные
сообщения длиной 300 байт пользователь может слать каждые 10 секунд. А длиной
30 Кб &mdash; уже раз в 15 секунд. Будет чаще &mdash; скоро дойдет до порога и будет убит.
Система подтвердила свою эффективность.</p>
<p>Наконец, последняя задача, которая была сделана неудовлетворительно &mdash; это
<b>управление сервером</b>. Оригинальный сервер содержал код, который проверял
каждое отправляемое сообщение. Если оно исходило от пользователя с именем
'<tt>#Kpot#</tt>' и имело специальный формат, то оно не отправлялось никому,
а служило управляющей командой серверу. Их было две: одна в формате
'<tt>*123.213.231.222</tt>' рассылала всем клиентам команду протокола #13
&laquo;сменить в настройках адрес альтернативного сервера на IP-адрес
123.213.231.222&raquo;. Другая, в формате '<tt>|123.213.231.22|</tt>'
называлась "ban", но означала просто &laquo;убить всех клиентов с IP-адреса
123.213.231.22&raquo;.</p>
<p>Чем плох такой подход? Во-первых, пользователи были даже не в курсе, что им
могли что-то поменять. Администрация сети знала о наличии такой возможности
(хотя без подробностей), и это было одним из аргументов по безопасности &mdash; кто
знает, какое еще управление клиентскими машинами туда встроено?..</p>
<p>Во-вторых, не было никакой аутентификации &mdash; <b>любой</b> злонамеренный
пользователь мог подключиться от этого имени и послать команду (и теоретически
потом дождаться на своём альтернативном сервере, использовать дыру в клиенте и
получить полный контроль над машинами). Да, клиент не давал ввести такое имя,
но кто мешает хакеру сделать свой мини-клиент...</p>
<p>В-третьих, сервер был вынужден обрабатывать текст сообщений, вместо
какого-нибудь стандартного средства управления.</p>
<p>Поэтому в seasrvkqd такое управление не было реализовано совсем &mdash; вместо
него было сделано своё, средствами Unix, доступное только администратору
сервера. И при том более гибкое: есть настоящие баны (после флуда, например),
можно задавать им таймаут, можно разбанивать, можно менять URL архива, можно
управлять процессом архивера, включать дебаг...</p>
<p>Впрочем, в этом проекте и протоколе, чтоб работало, хоть что-нибудь должно
быть сделано через анальный порт. Управление в seasrvkqd &mdash; довольно причудливая
комбинация из сигналов и чтения симлинка, выворачивающая привыкшему к типичным
средствам админу мозги набекрень. Просто по приколу ;)</p>
<p class="small" style="text-align: right;"><a href="#toc">назад к оглавлению</a></p>
<a name="seafixes"><h3>Возможные улучшения</h3></a>
<p>Внимательный читатель здесь заметит, что протокол, как бы он ни был плох,
всё же содержит в себе возможности расширения. Код под контролем, что-то можно
и поправить, нельзя же всё о плохом да о плохом. Ведь, как известно,
&laquo;критикуя &mdash; предлагай&raquo;. Действительно, профессионал &mdash; он на
то и профессионал, чтобы уметь и &laquo;из говна конфетку сделать&raquo;. В
конце концов, &laquo;...разгребание за нубами и исправление последствий
карусельного метода разработки студентами своих глючных поделий &mdash; это
весьма большой сегмент айтишного рынка на данный момент&raquo;.</p>
<p>И такая возможность была найдена. Было обнаружено, что как штатный клиент,
так и Blastcore всех версий игнорирует ту часть сообщения, что идет после
встречающегося в сообщении двоичного нуля '\0' &mdash; в Си это конец строки
(Blastcore же грузит текст как есть в написанный на Си системный контрол). Это
позволяет передавать после двоичного нуля (называемого также ASCIIZ)
расширенную информацию, которая будет проигнорирована старыми версиями.
Архивер был модифицирован, чтобы вести себя аналогично старой версии.</p>
<p>Далее был использован тот факт, что под поле длины команды отведено 3 байта.
Таким образом, в сообщении становится возможным передавать файлы и
форматированный в RTF текст, если сумма их не превышает 16 мегабайт. То есть,
сначала пишется просто текстовая версия, для старых клиентов, потом &mdash; её версия
с форматированием и приложенный файл. Старые версии проигнорируют кусок, новые
поймут.</p>
<p>Но в обратную сторону, от сервера к клиенту, поля длины в 3 байта нет.
Пришлось этот третий байт "располовинить" и воткнуть в старшую часть каждого
из байтов флага печатников &mdash; потому что оба младших уже были заняты. Сервер
уже поддерживает это изменение протокола, клиент (на начало октября 2010)
пока еще нет (версия 0.4 уже умеет принимать форматированный текст до 64 Кб,
но не может сам отправлять). Ну и можно видеть, что, хотя задача решена,
протокол превращается в сплошное нагромождение костылей и подпорок...</p>
<p>Тут надо сказать, что это &mdash; наиболее востребованное пользователями. Да,
теоретически там еще 240 номеров команд не занято в протоколе. Но старые
клиенты их не знают, надо обрабатывать на сервере. И в новых со старыми иметь
совместимость, попутно в новых командах для более серьезных фич (группы,
регистрация и т.д.) фактически изобретая еще один протокол. А раз по объему
кода получится как новый протокол, то лучше и сделать полностью новый
протокол, сделав шлюз к текущему. Если в случае шлюза TCPSender&lt;-&gt;SEA
Sender еще можно было спорить, что старые сканируют новых, одним сервером не
получится всё (но и это решаемо), то здесь такой проблемы не стоит. В новый
сервер sesrvkqd уже даже встроена рудиментарная поддержка соединения со шлюзом...</p>
<p>Тем более, что и код BlastCore далеко не идеален. Но пока что &mdash; умеем
выжимать насущное из того, что есть сейчас. Будущее, быть может, будет потом.
В следующем разделе.</p>
<p class="small" style="text-align: right;"><a href="#toc">назад к оглавлению</a></p>
<a name="thsender"><h2>Каким могло бы быть будущее</h2>
<h3>TheSender</h3></a>
<p>Как уже упоминалось <a href="#seasunset">ранее</a>, в 2006 году Вадим
Гончаров (nuclight) писал свой сендер. В <a href="#seashit">предыдущем разделе</a>
была показана важность проектирования и разработки хорошего протокола, поэтому
начал он именно с изучения опыта предшественников, альтернатив, и сначала
была написана
<a href="/~vadim/sender/thsproto.txt">спецификация протокола TheSender</a>
(рабочее название проекта). Написана она в стиле
<a href="http://www.rfc-editor.org/">RFC</a>, официальных документов и
стандартов Internet, с обоснованиями и выкладками, а потому несколько
тяжеловесным языком.</p>
<p>Что позволял этот протокол, сравнительно с предшественниками? Среди много
другого, были, например, такие возможности:</p>
<ul>
 <li>Регистрация пользователей: ID выдается один раз (как UIN в аське), а не
 случаен при каждом входе; аутентификация "по-взрослому" без передачи пароля по
 сети в открытом виде; становится возможным вносить "контакты" в "адресные
 книги", и т.д.</li>
 <li>Контроль над группой у её хозяев: можно банить, разрешать только чтение,
 но не посылку сообщений в группу, настраивать исключения, и т.д.</li>
 <li>Наличие многих групп пользователей, пользователи могут присоединяться и
 покидать их по своему желанию.</li>
 <li>Сообщения хранятся на сервере: только что включившийся пользователь
 может запросить с сервера как сообщения себе в приват за время отсутствия (так
 делает и ICQ), так и групповые сообщения &mdash; замена отдельного web-архива.</li>
 <li>Сообщения имеют идентификаторы, в том числе, ответом на какое другое
 сообщение является текущее. Так можно строить "деревья" ответов и фильтровать
 неинтересные пользователю "ветки" разговоров.</li>
 <li>У сообщений есть приоритеты, пользователь может фильтровать те сообщения,
 что не хочет видеть; администрация сети может рассылать "аварийные" оповещения
 особой важности.</li>
 <li>Некоторые сообщения могут быть "объявлениями" и висеть отдельно, до
 истечения их срока жизни &mdash; сейчас пользователям приходится регулярно повторять
 сообщения типа &laquo;продам ...&raquo;.</li>
 <li>У пользователя может быть много статусов, не только away, но и другие из
 ICQ (включая невидимость), плюс возможность указать собственный статус
 текстом.</li>
 <li>В аварийной ситуации клиенты в одной подсети могут продолжить работу без
 сервера (в случае SEA Sender и работ в серверной, пользователи при наличии
 сети остаются без связи, хотя именно в этом время она как раз нужнее).</li>
 <li>Новый клиент может автоматически настраиваться на находящийся рядом
 сервер и регистрироваться на нем (так же, как Windows автоматически получает
 IP-адрес). Все остальные сендеры требуют указания как минимум адреса сервера
 в настройках.</li>
 <li>Проверки на ошибки, в частности, в командах протокола есть сигнатура, при
 её несовпадении делается вывод о рассинхронизации клиента и сервера, вместо
 возникновения <a href="#seabugs">причудливых эффектов</a>.</li>
 <li>Указание кодировки текста &mdash; актуально для пользователей Unix-систем.</li>
 <li>Запросы подтверждения о доставке и прочтении сообщения получателем.</li>
 <li>Поддержка вложений файлов в сообщения, не только передача напрямую</li>
 <li>Экономный формат: передаются только те данные, которые обновились.</li>
 <li>Поддержка ников в дополнение к имени пользователя и машины (настраиваемое
 отображение в списке) и другие атрибуты пользователя и сообщений.</li>
 <li>Поддержка форматирования сообщений (и в чате тоже) в каком угодно виде:
 RTF, HTML, и т.д.</li>
 <li>И, конечно же, <b>расширяемость</b> &mdash; даже необходимые чат и передача
 файлов были сделаны как "стандартные" расширения, а были идеи и организовать
 запрос файлов с человека, аналог P2P, автообновления, групповой чат и др.</li>
</ul>
<p>Спецификация была почти закончена в октябре 2006 &mdash; оставались только неважные
для первоначальной реализации разделы вроде передачи файлов и кодировок. Затем
менее чем за месяц был написан сервер под Unix, 120 Кб (4800 строк) на чистом
Си, использовавший для хранения сообщений и информации о пользователях
BerkeleyDB. Но тестировать сервер не на чем, поэтому надо написать клиент, вот
он-то, как уже описывалось ранее, и не дожил до своего релиза, а вместе с ним
и вся система.</p>
<p>Вот так выглядел прототип:</p>
<a name="img-ths-main"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/thsender-main.png"
width="584" height="430" align="center" alt="" title=""></a>
<p>Можно заметить, что стиль цитирования такой же, как в e-mail (в дальнейшем
планировалось выделение цветом вместо разделителей -==-==- SEA Sender). На
части панели инструментов есть кнопка перехода к родительскому сообщению (то,
ответ на которое сейчас показывается) и кнопка отмены случайно удаленного (при
необходимости запросит с сервера) &mdash; решение проблемы "кто мне сейчас что
посылал, повторите, случайно удалил / сендер вылетел".</p>
<p>Далее идут кнопки-фильтры: из всего набора сообщений можно показать только
приватные. Или только групповые. Или только объявления... хотя для них
по-хорошему нужен отдельный интерфейс, но это позже &mdash; вообще, еще одна из
ошибок разработчиков заключается в том, что <b>пользователь не любит непривычного,
например, резкой смены интерфейса</b>. А если в этой группе кнопок не была
нажата ни одна &mdash; показывались все сообщения, как и во всех прежних сендерах:</p>
<a name="img-ths-main-combo"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/thsender-main-combo.png"
width="584" height="430" align="center" alt="" title=""></a>
<p>Показанные приоритеты, на самом деле, не являются чем-то, что устанавливал
только отправитель: можно определить свои собственные фильтры, воспользовавшись
так называемым <i>скорингом</i> &mdash; системе фильтров, присваивающих сообщению
оценку (score). Например, сообщения от юзера "Весёлый[FLOODER]" получают оценку
минус 10, сообщения со словом "внешка" &mdash; плюс 20 (или +100 для "сиськи"...).
Тогда может быть настроена, что сообщениям с отрицательной оценкой присваивать
низкий приоритет и автоматически проматывать их (а то и вообще не показывать).
Но если Весёлый[FLOODER] напишет что-то о внешке, в сумме сообщение получит +10
и таки будет показано. Это и есть правильное решение проблемы "кто печатает?"
вместо выделения отдельной группы (сами печатники, понятно, установят плюсовую
оценку).</p>
<p>Кроме создания фильтров (в том числе и динамических, т.е. на лету, например,
для ответов на какое-то одно сообщение) и сохранения вложенного файла, можно
выставить и свой статус (в том числе описать его словами):</p>
<a name="img-ths-main-msgstatus"><img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/thsender-main-msgstatus.png"
width="584" height="430" align="center" alt="" title=""></a>
<p>Выше уже было видно, что у пользователей в списке соответственно меняются
значки. Предполагалось пойти еще дальше. Так, фильтрацию сообщений по фразам
(без оценок, просто показ/не показ) планировал еще Александров в TCPSender. Он
же предполагал сделать и отображение списка пользователей в виде дерева, а еще
сделать настраиваемый вид юзера в списке. То есть, задается формат типа
<tt>'%1?{ [%2]}:{%3?{ [%2]}:{%2}}, %6'</tt>, где %1 &mdash; имя пользователя, %2 имя
машины, и т.д., и каждый сможет видеть так, как хочет. И сортировать список по
любому из полей...</p>
<p>Многое можно было бы еще сделать. Но... избежав ошибок предшественников,
nuclight допустил свою: <b>следует соразмерять планируемое к первой версии с
рынком и имеющимися ресурсами на реализацию</b>. Все предыдущие сендеры, как
уже говорилось, делались командой минимум из двух человек. Здесь же на задачу
бОльшего размера &mdash; был только один. Каким бы он ни был хорошим программистом,
объем задач есть объем задач. TheSender, глядя на присутствие в сети двух
общежитий, изначально рассчитывался на охват всего студгородка (в дальнейшем
планировалось сделать сеть связанных друг с другом серверов, как в IRC), что
еще более увеличивало объем работ.</p>
<p>В случае конкуренции продуктов на рынке ситуация еще более жесткая. Да,
разрабатываемая система может быть на голову выше конкурентов, и переманит к
себе львиную долю пользователей, как только выйдет, но если Вы разоритесь до
того, как успеете её сделать...</p>
<p>В общаге, конечно, не рынок и не кредиты на разработку &mdash; но суть остается
та же, просто вступают в дело аналогичные факторы-заменители (типа "сессия"
или "отчислился").</p>
<p>Позже, в принципе, можно было бы вернуться к проекту, но со временем стали
ясны некоторые недоработки &mdash; многое сейчас в протоколе следовало бы изменить,
что-то выкинуть, что-то добавить.</p>
<a name="img-miranda-historypp"></a>
<p>И не только в протоколе. Позже было выяснено, что многие пользователи не
считают сендер удобным, в частности, из-за необходимости "перемотки" сообщений
туда-сюда. Среди вариантов решения возникла идея сделать интерфейс похожим на
организацию блогов или IM-клиентов. Например, один из плагинов популярного
клиента Miranda имеет вот такой вид:</p>
<img src="http://seasrvkq.googlecode.com/svn/wiki/imgshist/miranda-historyplusplus.jpg"
width="762" height="605" align="center" alt="" title="">
<p>Это именно что интерфейс для отображения многострочных сообщений &mdash; границы
между ними четко видны, он останется сендером, а не чатом. Впрочем, это лишь
идея, над которой еще следует думать, опрашивать народ, и т.д.</p>
<p>Если найдется команда энтузиастов, которая решит, что им это по силам &mdash; то
сендер может получить новое обличие (тем более, что в текущий сервер уже
заложена рудиментарная поддержка шлюзования). Пока же система находится в
состоянии "как-то работает, и ладно", потому что этот результат мог быть
достигнут быстро &mdash; переписать сервер и клиент довольно примитивного SEA было
проще и быстрее, чем создать новую качественную систему. Так и живем с синицей
в руках.</p>
<p>До тех пор, пока кто-то не придет и не предложит лучшее.</p>
<p class="small" style="text-align: right;"><a href="#toc">назад к оглавлению</a></p>
<a name="#kpot"><h3>Предложение Крота</h3></a>
<p>В конце октября 2009 года #Kpot#
<a href="http://seasrvkq.googlecode.com/svn/wiki/Kpot_New_sender20091028.doc">предложил</a>
новую архитектуру сендера:
клиент на .NET, опрашивающий php/mysql-сервер по HTTP. Оно не было воплощено в
жизнь, и к лучшему, потому что описание предложенного вызвало, мягко говоря,
недоумение &mdash; это нечто еще более худшее, чем SEA Sender. Стоит процитировать
и разобрать наиболее яркие моменты:</p>
<blockquote>Поверьте, достаточно муторно работать с байтами (к тому же, если
отправитель послал n байт, получателю могут прийти все n разом, а могут и по
частям).</blockquote>
<p>Да, могут, такова природа TCP. Но ничего муторного в этом нет: это просто
надо учитывать в соответствующих циклах приема/отправки. В конце концов, это
делает большинство Internet-приложений (которые не Web).</p>
<blockquote>Плюс, нужно следить за разрывами соединения и делать реконнект.
Вторая проблема &mdash; самописный сервер. Это те же сокеты, только в большом
количестве, и работающие параллельно. Я обнаружил ещё один "прикол" сокетов &mdash;
иногда соединение повисает на несколько часов. При этом не срабатывает
коннект-таймаут, и исключения тоже не вылетает.</blockquote>
<p>А это, фактически, расписка в собственном неумении программировать сетевые
приложения. Хотя скорее, конечно, это нежелание разбираться с багами (и методами
их обхода) на той конкретной платформе, где ведется работа. В конце концов,
успешно работающие сервера без таких проблем есть на всех платформах, а на
некоторых они прекрасно обрабатывают десятки тысяч клиентов одновременно (как
"самописный" web-сервер nginx, например).</p>
<blockquote>В общем, идея новой архитектуры &mdash; отказ от собственного сервера,
и работа с сетью на высоком уровне &mdash; пусть всю мелкую работу сделают за
нас.</blockquote>
<p>Звучит как "мы столкнулись с проблемами и не осилили их". Нет, переложение
работы на нижележащие слои действительно было бы практичным, оправданным
решением &mdash; если бы давало преимущества. Но как видно будет далее, предлагаемое
решение на самом деле хуже.</p>
<p>Затем идет несколько хороших предложений: постоянные ID и регистрация
пользователей, глобальная таблица всех изменений. Но потом:</p>
<blockquote>Далее, каждые 10 секунд клиент обращается к ping.php и узнаёт об
изменениях на сервере.</blockquote>
<p>Кхм... Оставим в стороне воспоминания о web-чатах конца 90-х. Предположим,
в таблице уже висят 50 тысяч изменений. Тут приходит злой клиент и запрашивает
lastchange=1. На что сервер БД радостно перебирает ВСЮ историю. А еще клиент
может делать такие запросы гораздо чаще, чем раз в 10 секунд.</p>
<p>Впрочем, фиг с ними, со злоумышленниками. Здесь совершенно штатные клиенты
будут создавать постоянную нагрузку на сервер даже тогда, когда ничего не
происходит! Если 200 клиентов онлайн &mdash; это 20 запросов в секунду при полной
тишине, если 300 &mdash; уже 30, и еще больше, если кто-то начнет слать сообщения.
Которые, кстати, остальной группе будут доходить с задержкой до 10 секунд.
Средство IM, то есть обмена мгновенными сообщениями, что вы хотите.</p>
<blockquote>Чтобы не повторять код, список пользователей не передаётся в
connect.php, он передастся при ближайшем обращении к ping.php.</blockquote>
<p>Ну да, увеличим нагрузку на сервер на еще один запрос. Кстати, в этом
описании еще и <i>все</i> пользователи сети будут получать <i>полный</i> список
пользователей при коннекте нового, вместо просто события. А еще неизвестное
время дисконнекта: давно не пинговавших онлайновых придется чистить по таймеру,
что возвращает нас во времена даже не SEA Sender, а TCPSender &mdash; когда юзер мог
висеть в списке много минут, будучи уже в оффлайне...</p>
<p class="small" style="text-align: right;"><a href="#toc">назад к оглавлению</a></p>
<br><p style="text-align: center;">* * *</p><br>
<p>На том история &mdash; то, что было в прошлом &mdash; заканчивается. Дальше
начинается настоящее &mdash; и пусть тот, кто учел ошибки прошлого, сотворит
нечто лучшее в будущем. Респект всем тем, кто осилил прочитать весь текст до
конца :-)</p>
<hr width="26%" align="right">
<p class="small" style="text-align: right;">(c) nuclight, сентябрь 2009 &ndash; октябрь 2010</p>
